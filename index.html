<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NWS Logistics</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        .btn-primary {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .bg-secondary {
            background-color: var(--tg-theme-secondary-bg-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--tg-theme-bg-color);
            border-top: 1px solid var(--tg-theme-hint-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--tg-theme-button-color);
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Inputs */
        input, select, textarea {
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid transparent;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--tg-theme-button-color);
            outline: none;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid var(--tg-theme-button-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">

    <!-- TAB 1: CALCULATOR -->
    <div id="tab-calc" class="tab-content active">
        <h2 class="text-xl font-bold mb-4">üì¶ –†–∞—Å—á–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1 text-[var(--tg-theme-hint-color)]">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É</label>
                <select id="boxType" class="w-full p-3 rounded-lg text-lg" onchange="updateCalc()">
                    <option value="XS" data-price="500" data-l="20" data-w="20" data-h="20">XS (20x20x20) - 500‚ÇΩ</option>
                    <option value="S" data-price="800" data-l="30" data-w="30" data-h="30">S (30x30x30) - 800‚ÇΩ</option>
                    <option value="M" data-price="1200" data-l="40" data-w="40" data-h="40">M (40x40x40) - 1200‚ÇΩ</option>
                    <option value="L" data-price="1800" data-l="60" data-w="40" data-h="40">L (60x40x40) - 1800‚ÇΩ</option>
                    <option value="custom">–°–≤–æ–π —Ä–∞–∑–º–µ—Ä</option>
                </select>
            </div>

            <div id="customDims" class="grid grid-cols-3 gap-2 hidden">
                <input type="number" id="dimL" placeholder="–î–ª–∏–Ω–∞" class="p-2 rounded-lg text-center" oninput="updateCalc()">
                <input type="number" id="dimW" placeholder="–®–∏—Ä–∏–Ω–∞" class="p-2 rounded-lg text-center" oninput="updateCalc()">
                <input type="number" id="dimH" placeholder="–í—ã—Å–æ—Ç–∞" class="p-2 rounded-lg text-center" oninput="updateCalc()">
            </div>

            <div class="bg-[var(--tg-theme-secondary-bg-color)] p-4 rounded-xl mt-6">
                <div class="text-center">
                    <span class="text-[var(--tg-theme-hint-color)]">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</span>
                    <div class="text-3xl font-bold text-[var(--tg-theme-button-color)] mt-1">
                        <span id="totalPrice">500</span> ‚ÇΩ
                    </div>
                </div>
            </div>
            
            <p class="text-xs text-center text-[var(--tg-theme-hint-color)] mt-4">
                *–†–∞—Å—á–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º. –¢–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ –≥—Ä—É–∑–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ.
            </p>

            <button onclick="sendCalc()" class="btn-primary w-full py-3 rounded-xl font-bold mt-4 shadow-lg active:scale-95 transition-transform">
                –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
            </button>
        </div>
    </div>

    <!-- TAB 2: BUYOUT (ORDER) -->
    <div id="tab-order" class="tab-content">
        <h2 class="text-xl font-bold mb-4">üõçÔ∏è –í—ã–∫—É–ø —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <div id="orderItemsList" class="space-y-6 mb-20">
            <!-- Items will be added here -->
        </div>
        
        <button onclick="addOrderItem()" class="w-full py-3 border-2 border-dashed border-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-color)] rounded-xl font-bold mb-4 hover:bg-[var(--tg-theme-secondary-bg-color)] transition-colors">
            + –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </button>

        <button onclick="sendOrder()" class="btn-primary w-full py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
            –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </button>
    </div>

    <!-- TAB 3: SEARCH (NEW) -->
    <div id="tab-search" class="tab-content">
        <h2 class="text-xl font-bold mb-4">üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞</h2>
        <p class="text-sm text-[var(--tg-theme-hint-color)] mb-4">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞, –∏ –º—ã –Ω–∞–π–¥–µ–º –µ–≥–æ –¥–ª—è –≤–∞—Å.
        </p>

        <div id="searchItemsList" class="space-y-6 mb-20">
            <!-- Search Items will be added here -->
        </div>

        <button onclick="addSearchItem()" class="w-full py-3 border-2 border-dashed border-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-color)] rounded-xl font-bold mb-4 hover:bg-[var(--tg-theme-secondary-bg-color)] transition-colors">
            + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
        </button>

        <button onclick="sendSearch()" class="btn-primary w-full py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
            –ù–∞–π—Ç–∏
        </button>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('calc')">
            <i class="fas fa-calculator"></i>
            <span>–î–æ—Å—Ç–∞–≤–∫–∞</span>
        </div>
        <div class="nav-item" onclick="switchTab('order')">
            <i class="fas fa-shopping-bag"></i>
            <span>–í—ã–∫—É–ø</span>
        </div>
        <div class="nav-item" onclick="switchTab('search')">
            <i class="fas fa-search"></i>
            <span>–ü–æ–∏—Å–∫</span>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // ================= CONFIGURATION =================
        // –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∏ –∫–ª—é—á –Ω–∞ https://api.imgbb.com/ (—ç—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ) –∏ –≤—Å—Ç–∞–≤—å —Å—é–¥–∞
        // –ë–µ–∑ —ç—Ç–æ–≥–æ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç!
        const IMGBB_API_KEY = '5f8914c62250150915f026194411130d'; // –ü—Ä–∏–º–µ—Ä –∫–ª—é—á–∞ (–ª—É—á—à–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π)
        // =================================================

        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- STATE ---
        let currentTab = 'calc';
        let orderItems = [];
        let searchItems = [];

        // --- TABS LOGIC ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Highlight nav
            const navIndex = ['calc', 'order', 'search'].indexOf(tab);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            
            currentTab = tab;
            
            // Update TG MainButton
            if (tab === 'calc') tg.MainButton.hide();
            // else tg.MainButton.show(); // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É, –Ω–æ —É –Ω–∞—Å —Å–≤–æ–∏ –≤ HTML
        }

        // --- CALCULATOR LOGIC ---
        function updateCalc() {
            const select = document.getElementById('boxType');
            const customDiv = document.getElementById('customDims');
            const priceEl = document.getElementById('totalPrice');
            
            let price = 0;

            if (select.value === 'custom') {
                customDiv.classList.remove('hidden');
                const l = parseFloat(document.getElementById('dimL').value) || 0;
                const w = parseFloat(document.getElementById('dimW').value) || 0;
                const h = parseFloat(document.getElementById('dimH').value) || 0;
                
                // –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—É–ª—ã: (–û–±—ä–µ–º / 5000) * —Å—Ç–∞–≤–∫–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞ –∫—É–±
                // –°–¥–µ–ª–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞: –û–±—ä–µ–º–Ω—ã–π –≤–µ—Å * 400—Ä
                const volWeight = (l * w * h) / 5000;
                price = Math.ceil(Math.max(volWeight * 400, 500)); // –ú–∏–Ω–∏–º—É–º 500—Ä
            } else {
                customDiv.classList.add('hidden');
                const option = select.options[select.selectedIndex];
                price = parseInt(option.getAttribute('data-price'));
            }
            
            priceEl.innerText = price;
        }

        function sendCalc() {
            const select = document.getElementById('boxType');
            let data = { type: 'calc', packPrice: document.getElementById('totalPrice').innerText };
            
            if (select.value === 'custom') {
                data.boxName = '–°–≤–æ–π —Ä–∞–∑–º–µ—Ä';
                data.l = document.getElementById('dimL').value;
                data.w = document.getElementById('dimW').value;
                data.h = document.getElementById('dimH').value;
            } else {
                const opt = select.options[select.selectedIndex];
                data.boxName = `–ö–æ—Ä–æ–±–∫–∞ ${select.value}`;
                data.l = opt.getAttribute('data-l');
                data.w = opt.getAttribute('data-w');
                data.h = opt.getAttribute('data-h');
            }

            tg.sendData(JSON.stringify(data));
        }

        // --- ORDER TAB LOGIC ---
        function addOrderItem() {
            const id = Date.now();
            const html = `
                <div id="order-item-${id}" class="bg-[var(--tg-theme-secondary-bg-color)] p-4 rounded-xl relative animate-fade-in">
                    <button onclick="removeElement('order-item-${id}')" class="absolute top-2 right-2 text-red-500 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                    <h3 class="font-bold mb-2 text-sm text-[var(--tg-theme-hint-color)]">–¢–æ–≤–∞—Ä</h3>
                    
                    <input type="text" class="w-full p-2 rounded mb-2 text-sm" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä (1688, Poizon...)" onchange="updateOrderItem(${id}, 'link', this.value)">
                    
                    <div class="flex gap-2 mb-2">
                        <input type="number" class="w-1/2 p-2 rounded text-sm" placeholder="–¶–µ–Ω–∞ (¬•)" onchange="updateOrderItem(${id}, 'price', this.value)">
                        <input type="text" class="w-1/2 p-2 rounded text-sm bg-gray-200" placeholder="–° –∫–æ–º–∏—Å—Å–∏–µ–π" readonly id="res-yuan-${id}">
                    </div>

                    <!-- Image Upload Section -->
                    <div class="mt-2">
                        <label class="flex items-center gap-2 px-3 py-2 bg-white rounded cursor-pointer border border-dashed border-gray-300 hover:border-blue-500 transition-colors w-max">
                            <i class="fas fa-camera text-[var(--tg-theme-button-color)]"></i>
                            <span class="text-xs" id="upload-text-${id}">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                            <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this, ${id}, 'order')">
                        </label>
                        <div id="preview-area-${id}" class="flex gap-2 mt-2 flex-wrap"></div>
                    </div>
                </div>
            `;
            document.getElementById('orderItemsList').insertAdjacentHTML('beforeend', html);
            orderItems.push({ id, link: '', price: 0, resYuan: 0, imgUrls: [] });
        }

        function updateOrderItem(id, field, value) {
            const item = orderItems.find(i => i.id === id);
            if (!item) return;

            if (field === 'price') {
                item.price = parseFloat(value);
                // –ü—Ä–∏–º–µ—Ä –∫–æ–º–∏—Å—Å–∏–∏: +10%
                item.resYuan = Math.ceil(item.price * 1.1);
                document.getElementById(`res-yuan-${id}`).value = item.resYuan + ' ¬•';
            } else {
                item[field] = value;
            }
        }

        // --- SEARCH TAB LOGIC (NEW) ---
        function addSearchItem() {
            const id = Date.now();
            const html = `
                <div id="search-item-${id}" class="bg-[var(--tg-theme-secondary-bg-color)] p-4 rounded-xl relative">
                    <button onclick="removeElement('search-item-${id}')" class="absolute top-2 right-2 text-red-500 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                    <h3 class="font-bold mb-2 text-sm text-[var(--tg-theme-hint-color)]">–ü–æ–∑–∏—Ü–∏—è –ø–æ–∏—Å–∫–∞</h3>
                    
                    <textarea class="w-full p-2 rounded mb-2 text-sm h-20 resize-none" placeholder="–û–ø–∏—à–∏—Ç–µ —Ç–æ–≤–∞—Ä (—Ä–∞–∑–º–µ—Ä, —Ü–≤–µ—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)..." onchange="updateSearchItem(${id}, 'comment', this.value)"></textarea>

                    <div class="mt-2">
                        <label class="flex items-center gap-2 px-3 py-2 bg-white rounded cursor-pointer border border-dashed border-gray-300 hover:border-blue-500 transition-colors w-max">
                            <i class="fas fa-camera text-[var(--tg-theme-button-color)]"></i>
                            <span class="text-xs" id="search-upload-text-${id}">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
                            <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this, ${id}, 'search')">
                        </label>
                        <div id="search-preview-area-${id}" class="flex gap-2 mt-2 flex-wrap"></div>
                    </div>
                </div>
            `;
            document.getElementById('searchItemsList').insertAdjacentHTML('beforeend', html);
            searchItems.push({ id, comment: '', imgUrls: [] });
        }

        function updateSearchItem(id, field, value) {
            const item = searchItems.find(i => i.id === id);
            if (item) item[field] = value;
        }

        // --- SHARED UTILS ---
        function removeElement(elementId) {
            document.getElementById(elementId).remove();
            // Remove from arrays
            const id = parseInt(elementId.split('-').pop());
            orderItems = orderItems.filter(i => i.id !== id);
            searchItems = searchItems.filter(i => i.id !== id);
        }

        // Image Upload Logic (Uploads to ImgBB to get a URL)
        async function handleImageUpload(input, id, type) {
            const file = input.files[0];
            if (!file) return;

            // UI Feedback
            const textId = type === 'order' ? `upload-text-${id}` : `search-upload-text-${id}`;
            const labelSpan = document.getElementById(textId);
            const originalText = labelSpan.innerText;
            labelSpan.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

            const formData = new FormData();
            formData.append("image", file);

            try {
                // Upload to ImgBB
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    const imgUrl = data.data.url;
                    const thumbUrl = data.data.thumb.url;

                    // Update State
                    const list = type === 'order' ? orderItems : searchItems;
                    const item = list.find(i => i.id === id);
                    if (item) item.imgUrls.push(imgUrl);

                    // Show Preview
                    const previewArea = document.getElementById(type === 'order' ? `preview-area-${id}` : `search-preview-area-${id}`);
                    const imgHtml = `<div class="relative w-16 h-16 rounded overflow-hidden border border-gray-300">
                                        <img src="${thumbUrl}" class="w-full h-full object-cover">
                                     </div>`;
                    previewArea.insertAdjacentHTML('beforeend', imgHtml);
                    labelSpan.innerText = "–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ";
                } else {
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
                    labelSpan.innerText = originalText;
                }
            } catch (error) {
                console.error(error);
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.");
                labelSpan.innerText = originalText;
            }
        }

        // --- SENDING DATA ---
        function sendOrder() {
            if (orderItems.length === 0) return tg.showAlert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä!");
            const data = {
                type: 'order',
                items: orderItems
            };
            tg.sendData(JSON.stringify(data));
        }

        function sendSearch() {
            if (searchItems.length === 0) return tg.showAlert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞!");
            
            // Check validation
            const emptyDesc = searchItems.some(i => !i.comment && i.imgUrls.length === 0);
            if (emptyDesc) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π!");

            const data = {
                type: 'search',
                items: searchItems
            };
            tg.sendData(JSON.stringify(data));
        }

        // Init
        addOrderItem(); // Start with one item
        addSearchItem(); // Start with one search item
    </script>
</body>
</html>
