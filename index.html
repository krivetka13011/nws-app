<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NWS Logistics</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0f0f;
            --card-bg: #1c1c1e;
            --text-color: #ffffff;
            --text-secondary: #98989e;
            --accent-color: #3b82f6;
            --danger-color: #ef4444;
            --input-bg: #2c2c2e;
            --border-color: #3a3a3c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            /* Увеличили отступ снизу, чтобы контент не перекрывался фиксированными кнопками */
            padding-bottom: 160px; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Карточки */
        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        /* Кнопки */
        .btn-main {
            background-color: var(--accent-color);
            color: #ffffff;
            border-radius: 18px;
            font-weight: 600;
            font-size: 18px;
            transition: transform 0.1s, opacity 0.2s;
            /* Текст строго по центру */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-main:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .btn-secondary {
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px dashed var(--accent-color);
            color: var(--accent-color);
            border-radius: 18px;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.2s;
            /* Текст строго по центру */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-secondary:active {
            background-color: rgba(59, 130, 246, 0.2);
        }

        /* Поля ввода */
        input, textarea {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid transparent;
            border-radius: 16px;
            padding: 16px;
            width: 100%;
            font-size: 17px;
            transition: border-color 0.2s;
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-secondary);
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Custom Selector */
        .custom-select-trigger {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: 16px;
            padding: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 17px;
        }

        /* Radio Group */
        .delivery-option {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 18px 20px; /* Увеличили внутренние отступы */
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .delivery-option.active {
            background-color: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-color);
        }
        .delivery-option.active::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 18px;
            right: 18px;
            color: var(--accent-color);
            font-size: 20px;
        }

        /* Bottom Sheet */
        .sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            backdrop-filter: blur(3px);
        }
        .sheet-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .sheet-content {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            z-index: 101;
            padding: 20px 16px 40px 16px;
            transition: bottom 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        .sheet-overlay.open .sheet-content {
            bottom: 0;
        }
        
        .sheet-handle {
            width: 40px;
            height: 4px;
            background-color: #3a3a3c;
            border-radius: 2px;
            margin: 0 auto 20px auto;
        }

        .sheet-option {
            padding: 20px 16px; /* Больше отступов */
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 17px;
        }
        .sheet-option:last-child {
            border-bottom: none;
        }
        .sheet-option:active {
            background-color: var(--input-bg);
        }
        .sheet-option.selected {
            color: var(--accent-color);
            font-weight: 600;
        }

        /* Label Styles */
        .section-label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-left: 2px; /* Чуть сдвинули метку */
        }

        /* Tab Animation */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Fixed Areas - ИСПРАВЛЕНИЕ НАЛОЖЕНИЯ */
        .action-bar {
            position: fixed;
            bottom: 65px;
            left: 0;
            width: 100%;
            padding: 12px 16px;
            /* Сплошной фон, чтобы контент не просвечивал */
            background-color: var(--bg-color); 
            border-top: 1px solid var(--border-color); /* Разделитель */
            z-index: 40;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px; /* Чуть выше навигация */
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: var(--text-secondary);
            width: 33%;
            height: 100%;
        }
        .nav-item.active {
            color: var(--accent-color);
        }
        .nav-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .photo-btn {
            width: 80px;
            height: 80px;
            border-radius: 18px;
            background-color: var(--input-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .photo-btn i {
            color: var(--text-secondary);
            font-size: 24px;
        }

        /* Preview Item Styles */
        .preview-item {
            width: 80px;
            height: 80px;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
            flex-shrink: 0;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="p-4">

    <!-- TAB 1: CALCULATOR -->
    <div id="tab-calc" class="tab-content active">
        <h2 class="text-3xl font-bold mb-6 px-1 text-white">Калькулятор</h2>
        
        <div class="space-y-6">
            <div class="card p-5">
                <label class="section-label">Упаковка</label>
                
                <div class="custom-select-trigger" onclick="openBoxSheet()">
                    <span id="selectedBoxName" class="font-medium">Выберите упаковку</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                
                <div id="boxDesc" class="mt-4 text-[15px] leading-relaxed text-[var(--text-secondary)] bg-[var(--input-bg)] p-4 rounded-2xl hidden">
                    <!-- Dynamic Description -->
                </div>
            </div>

            <!-- Custom Dimensions Input -->
            <div id="customDims" class="hidden animate-fade-in">
                <div class="card p-5">
                    <label class="section-label">Габариты и Вес</label>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input type="number" id="dimL" placeholder="Длина (см)" class="text-center" oninput="updateCalc()">
                        <input type="number" id="dimW" placeholder="Ширина (см)" class="text-center" oninput="updateCalc()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="dimH" placeholder="Высота (см)" class="text-center" oninput="updateCalc()">
                        <input type="number" id="weight" placeholder="Вес (кг)" class="text-center" oninput="updateCalc()">
                    </div>
                </div>
            </div>

            <!-- Price Display -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-3xl p-8 text-white text-center shadow-lg mt-4">
                <span class="text-blue-200 text-base font-medium uppercase tracking-wide">Ориентировочная стоимость</span>
                <div class="text-5xl font-extrabold mt-3 tracking-tight">
                    <span id="totalPrice">0</span> ₽
                </div>
            </div>
            
            <p class="text-[12px] text-center text-[var(--text-secondary)] px-4 mt-4 leading-relaxed opacity-70">
                *Итоговая стоимость фиксируется после взвешивания на складе.
            </p>
        </div>
    </div>

    <!-- TAB 2: ORDER (BUYOUT) -->
    <div id="tab-order" class="tab-content">
        <h2 class="text-3xl font-bold mb-6 px-1 text-white">Выкуп</h2>
        
        <!-- DELIVERY TYPE SELECTOR -->
        <div class="card p-5 mb-6">
            <label class="section-label">Тип доставки</label>
            <div class="grid grid-cols-1 gap-4">
                <div class="delivery-option active" onclick="setDeliveryType('grey')" id="del-grey">
                    <div class="font-bold text-white text-lg mb-1">Серая доставка</div>
                    <div class="text-sm text-[var(--text-secondary)]">20-35 дней • Комиссия 5%</div>
                </div>
                <div class="delivery-option" onclick="setDeliveryType('white')" id="del-white">
                    <div class="font-bold text-white text-lg mb-1">Белая доставка</div>
                    <div class="text-sm text-[var(--text-secondary)]">12-15 дней • Комиссия 10%</div>
                </div>
            </div>
        </div>

        <div id="orderItemsList" class="space-y-4"></div>
        
        <button onclick="addOrderItem()" class="w-full mt-6 py-5 btn-secondary gap-2">
            <i class="fas fa-plus text-lg"></i> 
            <span class="text-lg">Добавить товар</span>
        </button>
    </div>

    <!-- TAB 3: SEARCH -->
    <div id="tab-search" class="tab-content">
        <h2 class="text-3xl font-bold mb-6 px-1 text-white">Поиск</h2>
        <div id="searchItemsList" class="space-y-4"></div>
        <button onclick="addSearchItem()" class="w-full mt-6 py-5 btn-secondary gap-2">
            <i class="fas fa-plus text-lg"></i> 
            <span class="text-lg">Добавить позицию</span>
        </button>
    </div>

    <!-- BOTTOM SHEET FOR BOX SELECTION -->
    <div class="sheet-overlay" id="boxSheet" onclick="closeBoxSheet(event)">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div class="sheet-handle" onclick="closeBoxSheet()"></div>
            <h3 class="text-xl font-bold mb-6 px-2 text-white">Выберите размер</h3>
            
            <div class="sheet-option" onclick="selectBox('Mini', 679, 'Вещи (футболка, сумка, ремень, носки)')">
                <div class="flex flex-col">
                    <span class="text-lg font-medium">Mini</span>
                    <span class="text-sm text-[var(--text-secondary)] mt-1">23x17x13 см</span>
                </div>
                <span class="text-blue-400 font-bold text-lg">679 ₽</span>
            </div>
            
            <div class="sheet-option" onclick="selectBox('Small', 1562, 'Пара обуви в коробке')">
                 <div class="flex flex-col">
                    <span class="text-lg font-medium">Small</span>
                    <span class="text-sm text-[var(--text-secondary)] mt-1">36x26x14 см</span>
                </div>
                <span class="text-blue-400 font-bold text-lg">1562 ₽</span>
            </div>
            
            <div class="sheet-option" onclick="selectBox('Large', 2411, 'Пара обуви в коробке + несколько вещей')">
                 <div class="flex flex-col">
                    <span class="text-lg font-medium">Large</span>
                    <span class="text-sm text-[var(--text-secondary)] mt-1">40x29x16 см</span>
                </div>
                <span class="text-blue-400 font-bold text-lg">2411 ₽</span>
            </div>
            
            <div class="sheet-option" onclick="selectBox('X-Large', 3489, 'Две пары обуви в коробке + несколько вещей')">
                 <div class="flex flex-col">
                    <span class="text-lg font-medium">X-Large</span>
                    <span class="text-sm text-[var(--text-secondary)] mt-1">37x29x28 см</span>
                </div>
                <span class="text-blue-400 font-bold text-lg">3489 ₽</span>
            </div>
            
            <div class="sheet-option" onclick="selectBox('custom', 0, 'Расчет по объемному весу')">
                <span class="text-lg">Свой размер</span>
                <span class="text-[var(--text-secondary)] text-sm">Калькулятор</span>
            </div>
        </div>
    </div>

    <!-- FIXED ACTION BUTTONS -->
    <div class="action-bar">
        <button id="btn-action-calc" onclick="sendCalc()" class="btn-main w-full py-4 text-lg shadow-xl">Рассчитать</button>
        <button id="btn-action-order" onclick="sendOrder()" class="btn-main w-full py-4 text-lg shadow-xl hidden">Оформить заказ</button>
        <button id="btn-action-search" onclick="sendSearch()" class="btn-main w-full py-4 text-lg shadow-xl hidden">Найти</button>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('calc')">
            <i class="fas fa-calculator"></i>
            <span>Калькулятор</span>
        </div>
        <div class="nav-item" onclick="switchTab('order')">
            <i class="fas fa-shopping-bag"></i>
            <span>Выкуп</span>
        </div>
        <div class="nav-item" onclick="switchTab('search')">
            <i class="fas fa-search"></i>
            <span>Поиск</span>
        </div>
    </div>

    <script>
        // КЛЮЧ ИЗ ВАШЕГО РАБОЧЕГО КОДА
        const IMGBB_KEY = '412d2791dd8620104d0849b745f489e0'; 
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#0f0f0f');
        tg.setBackgroundColor('#0f0f0f');

        const RATE_MULTIPLIER = 13; 
        
        let currentTab = 'calc';
        let orderItems = [];
        let searchItems = [];
        let deliveryType = 'grey'; 

        // --- 1. ФУНКЦИЯ СЖАТИЯ ФОТО (ИЗ ВАШЕГО КОДА) ---
        async function compressImage(file, maxWidth = 1024, maxHeight = 1024, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, file.type, quality);
                };
                img.onerror = reject;
            });
        }

        // --- Delivery Type Logic ---
        function setDeliveryType(type) {
            deliveryType = type;
            document.querySelectorAll('.delivery-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`del-${type}`).classList.add('active');
            orderItems.forEach(item => {
                updateOrderItem(item.id, 'price', item.price, true);
            });
        }

        // --- Custom Box Selector Logic ---
        let currentBox = { type: '', price: 0, l:0, w:0, h:0 };

        function openBoxSheet() {
            document.getElementById('boxSheet').classList.add('open');
        }

        function closeBoxSheet(event) {
            if (!event || event.target === document.getElementById('boxSheet') || event.target.classList.contains('sheet-handle')) {
                document.getElementById('boxSheet').classList.remove('open');
            }
        }

        function selectBox(type, price, desc) {
            currentBox.type = type;
            currentBox.price = price;

            const triggerText = document.getElementById('selectedBoxName');
            const descEl = document.getElementById('boxDesc');
            const customDiv = document.getElementById('customDims');
            
            document.querySelectorAll('.sheet-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            if (type === 'custom') {
                triggerText.innerText = "Свой размер";
                descEl.classList.remove('hidden');
                descEl.innerText = desc;
                customDiv.classList.remove('hidden');
            } else {
                triggerText.innerText = type; 
                descEl.classList.remove('hidden');
                descEl.innerText = desc;
                customDiv.classList.add('hidden');
                
                const sizes = {'Mini': [23,17,13], 'Small': [36,26,14], 'Large': [40,29,16], 'X-Large': [37,29,28]};
                if(sizes[type]) {
                    [currentBox.l, currentBox.w, currentBox.h] = sizes[type];
                }
            }

            updateCalc();
            document.getElementById('boxSheet').classList.remove('open');
        }

        // --- Tabs Logic ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-action-calc').classList.add('hidden');
            document.getElementById('btn-action-order').classList.add('hidden');
            document.getElementById('btn-action-search').classList.add('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`btn-action-${tab}`).classList.remove('hidden');
            const navIndex = ['calc', 'order', 'search'].indexOf(tab);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            currentTab = tab;
            if(tab === 'order' && orderItems.length === 0) addOrderItem();
            if(tab === 'search' && searchItems.length === 0) addSearchItem();
        }

        // --- Calc Logic ---
        function updateCalc() {
            const priceEl = document.getElementById('totalPrice');
            let price = 0;
            
            if (currentBox.type === 'custom') {
                const l = parseFloat(document.getElementById('dimL').value) || 0;
                const w = parseFloat(document.getElementById('dimW').value) || 0;
                const h = parseFloat(document.getElementById('dimH').value) || 0;
                const weight = parseFloat(document.getElementById('weight').value) || 0;
                
                if (l === 0 || w === 0 || h === 0 || weight === 0) {
                     price = 0;
                } else {
                    const volWeight = (l * w * h) / 5000;
                    const finalWeight = Math.max(volWeight, weight);
                    price = Math.ceil(Math.max(finalWeight * 450, 500)); 
                }
            } else {
                price = currentBox.price;
            }
            priceEl.innerText = price;
        }

        function sendCalc() {
            if (!currentBox.type) return tg.showAlert("Выберите упаковку!");
            if (currentBox.type === 'custom' && document.getElementById('totalPrice').innerText === '0') return tg.showAlert("Введите габариты и вес!");
            
            let data = { type: 'calc', packPrice: document.getElementById('totalPrice').innerText };
            if (currentBox.type === 'custom') {
                data.boxName = 'Свой размер';
                data.l = document.getElementById('dimL').value;
                data.w = document.getElementById('dimW').value;
                data.h = document.getElementById('dimH').value;
                data.weight = document.getElementById('weight').value;
            } else {
                data.boxName = `Коробка ${currentBox.type}`;
                data.l = currentBox.l; data.w = currentBox.w; data.h = currentBox.h;
            }
            tg.sendData(JSON.stringify(data));
        }

        // --- Order Logic ---
        function addOrderItem() {
            const id = Date.now();
            const html = `
                <div id="order-item-${id}" class="card p-5 relative animate-fade-in">
                    <button onclick="removeElement('order-item-${id}', 'order')" class="delete-btn absolute top-4 right-4 text-[var(--danger-color)] p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <label class="section-label">Товар</label>
                    <input type="text" class="mb-4" placeholder="Ссылка на товар" onchange="updateOrderItem(${id}, 'link', this.value)">
                    <div class="flex gap-4 mb-4">
                        <div class="w-1/2">
                            <input type="number" placeholder="Цена (¥)" oninput="updateOrderItem(${id}, 'price', this.value)">
                        </div>
                        <div class="w-1/2 bg-[var(--input-bg)] rounded-2xl flex items-center justify-center border border-[var(--border-color)]">
                            <span id="res-rub-${id}" class="text-xl font-bold text-[var(--text-secondary)]">0 ₽</span>
                        </div>
                    </div>
                    <!-- Photo container -->
                    <div class="flex flex-wrap gap-2 items-center" id="preview-area-${id}">
                        <label class="photo-btn hover:border-blue-500 transition-colors">
                            <i class="fas fa-camera"></i>
                            <input type="file" accept="image/*" multiple class="hidden" onchange="handleImageUpload(this, ${id}, 'order')">
                        </label>
                        <!-- Previews will appear here -->
                    </div>
                </div>
            `;
            document.getElementById('orderItemsList').insertAdjacentHTML('beforeend', html);
            orderItems.push({ id, link: '', price: 0, resYuan: 0, imgUrls: [] });
            updateDeleteButtons('order');
        }

        function updateOrderItem(id, field, value, forceUpdate = false) {
            const item = orderItems.find(i => i.id === id);
            if (!item) return;

            if (field === 'price' || forceUpdate) {
                const val = parseFloat(value) || 0;
                item.price = val;
                
                if (val === 0) {
                     document.getElementById(`res-rub-${id}`).innerText = `0 ₽`;
                     item.resYuan = 0;
                } else {
                    const commission = deliveryType === 'white' ? 1.10 : 1.05;
                    const rub = Math.ceil( (val + 30) * commission * RATE_MULTIPLIER );
                    item.resYuan = val; 
                    document.getElementById(`res-rub-${id}`).innerText = `${rub} ₽`;
                }
            } else {
                item[field] = value;
            }
        }

        function sendOrder() {
            if (orderItems.length === 0) return tg.showAlert("Пустой заказ!");
            const data = { 
                type: 'order', 
                items: orderItems,
                deliveryType: deliveryType === 'white' ? 'Белая (12-15 дн)' : 'Серая (20-35 дн)'
            };
            tg.sendData(JSON.stringify(data));
        }

        // --- Search Logic ---
        function addSearchItem() {
            const id = Date.now();
            const html = `
                <div id="search-item-${id}" class="card p-5 relative animate-fade-in">
                    <button onclick="removeElement('search-item-${id}', 'search')" class="delete-btn absolute top-4 right-4 text-[var(--danger-color)] p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <label class="section-label">Позиция</label>
                    <textarea class="mb-4 h-28 resize-none" placeholder="Комментарий" onchange="updateSearchItem(${id}, 'comment', this.value)"></textarea>
                    <div class="flex flex-wrap gap-2 items-center" id="search-preview-area-${id}">
                        <label class="photo-btn hover:border-blue-500 transition-colors">
                            <i class="fas fa-camera"></i>
                            <input type="file" accept="image/*" multiple class="hidden" onchange="handleImageUpload(this, ${id}, 'search')">
                        </label>
                    </div>
                </div>
            `;
            document.getElementById('searchItemsList').insertAdjacentHTML('beforeend', html);
            searchItems.push({ id, comment: '', imgUrls: [] });
            updateDeleteButtons('search');
        }

        function updateSearchItem(id, field, value) {
            const item = searchItems.find(i => i.id === id);
            if (item) item[field] = value;
        }

        function removeElement(elementId, type) {
            const list = type === 'order' ? orderItems : searchItems;
            if (list.length <= 1) return;
            document.getElementById(elementId).remove();
            const id = parseInt(elementId.split('-').pop());
            if (type === 'order') {
                orderItems = orderItems.filter(i => i.id !== id);
            } else {
                searchItems = searchItems.filter(i => i.id !== id);
            }
            updateDeleteButtons(type);
        }

        function updateDeleteButtons(type) {
            const list = type === 'order' ? orderItems : searchItems;
            const containerId = type === 'order' ? 'orderItemsList' : 'searchItemsList';
            const buttons = document.querySelectorAll(`#${containerId} .delete-btn`);
            buttons.forEach(btn => {
                btn.style.display = list.length > 1 ? 'block' : 'none';
            });
        }

        // --- 2. НОВАЯ ЛОГИКА ЗАГРУЗКИ С MULTIPLE И УДАЛЕНИЕМ ---
        async function handleImageUpload(input, id, type) {
            const files = input.files;
            if (!files || files.length === 0) return;

            const previewArea = document.getElementById(type === 'order' ? `preview-area-${id}` : `search-preview-area-${id}`);
            // Вставляем лоадер перед кнопкой загрузки (кнопка - первый элемент в flex container, но мы используем insertAdjacentHTML)
            // Чтобы порядок был верным (фото слева направо), фото будут добавляться перед кнопкой.
            // Но кнопка у нас в HTML стоит первой. Сделаем, чтобы фото добавлялись ПЕРЕД кнопкой? Нет, обычно фото идут списком, а кнопка "+" в конце.
            // В текущей верстке кнопка label внутри div.
            
            // Мы будем вставлять фото ПЕРЕД кнопкой (label)
            const btnLabel = previewArea.querySelector('label');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const loadId = `load-${Date.now()}-${i}`;
                const loadingHtml = `<div id="${loadId}" class="photo-btn animate-pulse border-none"><i class="fas fa-spinner fa-spin text-white"></i></div>`;
                
                // Вставляем лоадер перед кнопкой
                btnLabel.insertAdjacentHTML('beforebegin', loadingHtml);

                try {
                    const compressedBlob = await compressImage(file);
                    const formData = new FormData();
                    formData.append("image", compressedBlob, file.name);

                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                        method: "POST",
                        body: formData
                    });
                    
                    const data = await response.json();
                    document.getElementById(loadId).remove();

                    if (data.success) {
                        const imgUrl = data.data.url;
                        const thumbUrl = data.data.thumb.url;

                        const list = type === 'order' ? orderItems : searchItems;
                        const item = list.find(i => i.id === id);
                        if (item) item.imgUrls.push(imgUrl);

                        // Создаем элемент превью с кнопкой удаления
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'preview-item';
                        imgDiv.innerHTML = `
                            <img src="${thumbUrl}">
                            <div class="preview-remove" onclick="removeImage(${id}, '${imgUrl}', '${type}', this)">
                                <i class="fas fa-times"></i>
                            </div>
                        `;
                        
                        btnLabel.insertAdjacentElement('beforebegin', imgDiv);
                    } else {
                        tg.showAlert("Ошибка загрузки фото");
                    }
                } catch (error) {
                    if(document.getElementById(loadId)) document.getElementById(loadId).remove();
                    tg.showAlert("Ошибка сети");
                }
            }
            // Сбрасываем input, чтобы можно было загрузить те же фото снова при желании
            input.value = '';
        }

        function removeImage(itemId, imgUrl, type, btnElement) {
            const list = type === 'order' ? orderItems : searchItems;
            const item = list.find(i => i.id === itemId);
            if (item) {
                item.imgUrls = item.imgUrls.filter(url => url !== imgUrl);
            }
            // Удаляем DOM элемент (родитель кнопки удаления - .preview-item)
            btnElement.parentElement.remove();
        }

        function sendSearch() {
            if (searchItems.length === 0) return tg.showAlert("Пустой поиск!");
            tg.sendData(JSON.stringify({ type: 'search', items: searchItems }));
        }
        
        // Init
        document.body.style.backgroundColor = "var(--bg-color)";
        document.getElementById('selectedBoxName').innerText = "Выберите упаковку";
    </script>
</body>
</html>
