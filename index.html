<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NWS Logistics</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: rgba(20, 25, 35, 0.7);
            --text-color: #ffffff;
            --text-secondary: #94a3b8;
            --primary-color: #3b82f6; 
            --accent-glow: 0 0 15px rgba(59, 130, 246, 0.25);
            --border-color: rgba(59, 130, 246, 0.2);
            --border-active: #3b82f6;
            --active-bg: rgba(59, 130, 246, 0.1);
            --danger-color: #ef4444;
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            overscroll-behavior: none;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #0f172a 0%, #020617 80%);
            color: var(--text-color);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 0; 
        }

        /* --- UI Elements --- */
        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .btn-main {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #ffffff;
            border-radius: 16px;
            font-weight: 600;
            font-size: 17px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-main:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2); }

        .btn-secondary {
            background-color: var(--active-bg);
            border: 1px dashed var(--border-active);
            color: #60a5fa;
            border-radius: 16px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-secondary:active { background-color: rgba(59, 130, 246, 0.2); }

        /* Inputs */
        input, textarea {
            background-color: rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 18px 20px;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }
        input.text-center { padding: 18px 10px; }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--border-active);
            box-shadow: var(--accent-glow);
            background-color: rgba(0, 0, 0, 0.5);
        }

        .price-result-box {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 700; color: var(--text-secondary);
        }
        .price-result-box.active-price {
            color: #fff;
            border-color: var(--border-active);
            box-shadow: var(--accent-glow);
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            background-color: var(--active-bg);
        }

        .custom-select-trigger, .option-box, .crate-option {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--text-color);
            font-size: 16px; font-weight: 500;
        }
        .option-box { display: block; position: relative; overflow: hidden; }
        .option-box.active, .crate-option.active {
            background-color: var(--active-bg);
            border-color: var(--border-active);
            box-shadow: var(--accent-glow);
        }
        
        .option-title, .crate-text { color: #fff; font-weight: 600; font-size: 16px; margin-bottom: 2px; }
        .option-sub { color: var(--text-secondary); font-size: 13px; }
        .option-price, .crate-price { color: #60a5fa; font-weight: bold; }
        .crate-text { margin-bottom: 0; }

        .section-label {
            display: block; font-size: 13px; font-weight: 600;
            color: #60a5fa; margin-bottom: 12px;
            text-transform: uppercase; letter-spacing: 0.05em;
            padding-left: 4px;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }

        /* Lightbox */
        .lightbox-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
        }
        .lightbox-overlay.open { opacity: 1; pointer-events: auto; }
        .lightbox-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .lightbox-close {
            position: absolute; top: 20px; right: 20px;
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px; cursor: pointer;
            backdrop-filter: blur(5px); z-index: 10000;
        }

        /* History */
        .history-item {
            background-color: rgba(30, 41, 59, 0.4); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 16px; margin-bottom: 12px; cursor: pointer;
        }
        .history-item:active { background-color: var(--active-bg); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .history-type { font-weight: 700; color: #60a5fa; font-size: 14px; text-transform: uppercase; }
        .history-date { color: var(--text-secondary); font-size: 12px; }
        .history-details { font-size: 14px; color: #fff; line-height: 1.4; }
        .history-price { margin-top: 6px; font-weight: 600; color: #fff; text-align: right; }
        .history-imgs {
            display: flex; gap: 8px; margin-top: 12px;
            overflow-x: auto; padding-bottom: 4px;
            scrollbar-width: none;
        }
        .history-imgs::-webkit-scrollbar { display: none; }
        .history-img-thumb {
            width: 60px; height: 60px; border-radius: 12px; object-fit: cover;
            border: 1px solid var(--border-color); flex-shrink: 0;
            background-color: rgba(0,0,0,0.3);
        }

        /* Sheets & Nav */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); z-index: 100;
            opacity: 0; visibility: hidden; transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        .sheet-overlay.open { opacity: 1; visibility: visible; }
        .sheet-content {
            position: fixed; bottom: -100%; left: 0; right: 0;
            background-color: #0f172a; border-top: 1px solid var(--border-active);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            z-index: 101; padding: 24px 16px 40px 16px;
            transition: bottom 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
            max-height: 85vh; overflow-y: auto;
            box-shadow: 0 -5px 30px rgba(59, 130, 246, 0.2);
        }
        .sheet-overlay.open .sheet-content { bottom: 0; }
        .sheet-handle { width: 40px; height: 4px; background-color: #334155; border-radius: 2px; margin: 0 auto 20px auto; }
        .sheet-option {
            padding: 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);
            color: var(--text-color); display: flex; justify-content: space-between; align-items: center; font-size: 17px;
        }
        .sheet-option:last-child { border-bottom: none; }
        .sheet-option:active { background-color: rgba(255,255,255,0.05); }
        .sheet-option.selected { color: #60a5fa; font-weight: 600; }

        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .action-bar { position: fixed; bottom: 85px; left: 0; width: 100%; padding: 0 16px; z-index: 40; pointer-events: none; }
        .action-bar button { pointer-events: auto; box-shadow: 0 8px 30px rgba(0,0,0,0.5); }

        .bottom-nav {
            position: fixed; bottom: 20px; left: 16px; right: 16px; height: 60px;
            background-color: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px);
            border: 1px solid var(--border-color); border-radius: 20px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; color: var(--text-secondary); width: 25%; height: 100%;
            transition: all 0.3s; position: relative;
        }
        .nav-item i { font-size: 20px; margin-bottom: 3px; transition: all 0.3s; }
        .nav-item.active { color: #fff; }
        .nav-item.active i { color: #60a5fa; filter: drop-shadow(0 0 8px rgba(96, 165, 250, 0.6)); transform: translateY(-2px); }

        .photo-btn {
            width: 80px; height: 80px; border-radius: 18px; background-color: rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 1px dashed var(--border-color); flex-shrink: 0; transition: all 0.2s;
        }
        .photo-btn:active { border-color: var(--border-active); background-color: var(--active-bg); }
        .photo-btn i { color: var(--text-secondary); font-size: 24px; }
        .preview-item {
            width: 80px; height: 80px; border-radius: 18px; overflow: hidden;
            border: 1px solid var(--border-color); position: relative; flex-shrink: 0;
        }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-remove {
            position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6);
            color: white; border-radius: 50%; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;
        }

        /* Detail Sheet */
        .history-detail-scroll { max-height: 70vh; overflow-y: auto; padding-bottom: 40px; }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .detail-label { color: var(--text-secondary); font-size: 14px; }
        .detail-value { color: #fff; font-weight: 500; font-size: 14px; text-align: right;}
        .detail-item-card { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .detail-item-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .detail-item-link { color: #60a5fa; font-size: 13px; text-decoration: underline; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%; }
        .detail-item-price { color: #fff; font-weight: bold; font-size: 14px; }
        .detail-item-imgs { display: flex; gap: 8px; overflow-x: auto; margin-top: 8px; }
        .detail-item-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color); }
        
        .scroll-spacer { height: 200px; width: 100%; flex-shrink: 0; }
    </style>
</head>
<body class="p-4">

    <!-- LIGHTBOX -->
    <div class="lightbox-overlay" id="lightbox">
        <div class="lightbox-close" onclick="closeLightbox()"><i class="fas fa-times"></i></div>
        <img src="" class="lightbox-img" id="lightboxImg">
    </div>

    <!-- TAB 1: CALCULATOR -->
    <div id="tab-calc" class="tab-content active">
        <h2 class="text-3xl font-bold mb-6 px-2 text-white">Калькулятор</h2>
        <div class="space-y-5">
            <div class="card p-5">
                <label class="section-label">Упаковка</label>
                <div class="custom-select-trigger mb-4" onclick="openBoxSheet()">
                    <span id="selectedBoxName" class="font-medium">Выберите упаковку</span>
                    <i class="fas fa-chevron-down text-gray-400"></i>
                </div>
                
                <div id="boxDesc" class="mt-2 mb-4 text-[14px] leading-relaxed text-[var(--text-secondary)] bg-[rgba(0,0,0,0.3)] p-4 rounded-2xl hidden border border-[var(--border-color)]"></div>
                
                <div class="option-box crate-row" id="crateOption" onclick="toggleCrate()">
                    <span class="option-title">Обрешетка</span>
                    <span class="option-price">+299 ₽</span>
                </div>
            </div>
            <div id="customDims" class="hidden animate-fade-in">
                <div class="card p-5">
                    <label class="section-label">Габариты и Вес</label>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input type="number" id="dimL" placeholder="Длина (см)" class="text-center" oninput="updateCalc()">
                        <input type="number" id="dimW" placeholder="Ширина (см)" class="text-center" oninput="updateCalc()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="dimH" placeholder="Высота (см)" class="text-center" oninput="updateCalc()">
                        <input type="number" id="weight" placeholder="Вес (кг)" class="text-center" oninput="updateCalc()">
                    </div>
                </div>
            </div>
            <div class="card p-6 text-center" style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.2) 0%, rgba(30, 58, 138, 0.3) 100%); border-color: var(--border-active);">
                <span class="text-blue-200 text-sm font-medium uppercase tracking-widest" style="text-shadow: 0 0 10px rgba(96, 165, 250, 0.5);">Ориентировочно</span>
                <div class="text-5xl font-extrabold mt-3 tracking-tight text-white" style="text-shadow: 0 0 20px rgba(96, 165, 250, 0.6);">
                    <span id="totalPrice">0</span> ₽
                </div>
            </div>
            <p class="text-[12px] text-center text-[var(--text-secondary)] px-4 mt-2 opacity-60">
                *Итоговая стоимость фиксируется на складе.
            </p>
        </div>
        <div class="scroll-spacer"></div>
    </div>

    <!-- TAB 2: ORDER -->
    <div id="tab-order" class="tab-content">
        <h2 class="text-3xl font-bold mb-6 px-2 text-white">Выкуп</h2>
        <div class="card p-5 mb-6">
            <label class="section-label">Тип доставки</label>
            <div class="grid grid-cols-1 gap-3">
                <div class="option-box active" onclick="setDeliveryType('grey')" id="del-grey">
                    <div class="option-title">Серая доставка</div>
                    <div class="option-sub">20-35 дней • Комиссия 5%</div>
                </div>
                <div class="option-box" onclick="setDeliveryType('white')" id="del-white">
                    <div class="option-title">Белая доставка</div>
                    <div class="option-sub">12-15 дней • Комиссия 10%</div>
                </div>
            </div>
        </div>
        <div id="orderItemsList" class="space-y-4"></div>
        <button onclick="addOrderItem()" class="w-full mt-6 py-4 btn-secondary gap-2 border-dashed">
            <i class="fas fa-plus text-lg"></i> <span class="text-lg">Добавить товар</span>
        </button>
        <div class="scroll-spacer"></div>
    </div>

    <!-- TAB 3: SEARCH -->
    <div id="tab-search" class="tab-content">
        <h2 class="text-3xl font-bold mb-6 px-2 text-white">Поиск</h2>
        <div id="searchItemsList" class="space-y-4"></div>
        <button onclick="addSearchItem()" class="w-full mt-6 py-4 btn-secondary gap-2 border-dashed">
            <i class="fas fa-plus text-lg"></i> <span class="text-lg">Добавить позицию</span>
        </button>
        <div class="scroll-spacer"></div>
    </div>

    <!-- TAB 4: HISTORY -->
    <div id="tab-history" class="tab-content">
        <h2 class="text-3xl font-bold mb-6 px-2 text-white">История</h2>
        <div id="historyList" class="space-y-4"></div>
        <div class="scroll-spacer"></div>
    </div>

    <!-- BOX SHEET -->
    <div class="sheet-overlay" id="boxSheet" onclick="closeBoxSheet(event)">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div class="sheet-handle" onclick="closeBoxSheet()"></div>
            <h3 class="text-xl font-bold mb-6 px-2 text-white">Выберите размер</h3>
            <div class="sheet-option" onclick="selectBox('Mini', 679, 'Вещи (футболка, сумка, ремень, носки)')">
                <div class="flex flex-col"><span class="text-lg font-medium text-white">Mini</span><span class="text-sm text-[var(--text-secondary)] mt-1">23x17x13 см, до 0.6 кг</span></div>
                <span class="text-blue-400 font-bold text-lg">679 ₽</span>
            </div>
            <div class="sheet-option" onclick="selectBox('Small', 1562, 'Пара обуви в коробке')">
                 <div class="flex flex-col"><span class="text-lg font-medium text-white">Small</span><span class="text-sm text-[var(--text-secondary)] mt-1">36x26x14 см, до 1.5 кг</span></div>
                <span class="text-blue-400 font-bold text-lg">1 562 ₽</span>
            </div>
            <div class="sheet-option" onclick="selectBox('Large', 2411, 'Пара обуви в коробке + несколько вещей')">
                 <div class="flex flex-col"><span class="text-lg font-medium text-white">Large</span><span class="text-sm text-[var(--text-secondary)] mt-1">40x29x16 см, до 2.5 кг</span></div>
                <span class="text-blue-400 font-bold text-lg">2 411 ₽</span>
            </div>
            <div class="sheet-option" onclick="selectBox('X-Large', 3489, 'Две пары обуви в коробке + несколько вещей')">
                 <div class="flex flex-col"><span class="text-lg font-medium text-white">X-Large</span><span class="text-sm text-[var(--text-secondary)] mt-1">37x29x28 см, до 3.5 кг</span></div>
                <span class="text-blue-400 font-bold text-lg">3 489 ₽</span>
            </div>
            <div class="sheet-option" onclick="selectBox('custom', 0, 'Расчет по объемному весу')">
                <span class="text-lg text-white">Свой размер</span>
                <span class="text-[var(--text-secondary)] text-sm">Калькулятор</span>
            </div>
        </div>
    </div>

    <!-- DETAILS SHEET -->
    <div class="sheet-overlay" id="historyDetailSheet" onclick="closeHistoryDetails(event)">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div class="sheet-handle" onclick="closeHistoryDetails()"></div>
            <h3 class="text-xl font-bold mb-4 px-2 text-white" id="detailTitle">Детали заказа</h3>
            <div class="card p-4 mb-4">
                <div class="detail-row"><span class="detail-label">Дата и время</span><span class="detail-value" id="detailDate"></span></div>
                <div class="detail-row"><span class="detail-label">Тип доставки</span><span class="detail-value" id="detailDelivery"></span></div>
                <div class="detail-row" style="border-bottom:none;"><span class="detail-label">Итоговая сумма</span><span class="detail-value text-[#60a5fa]" id="detailTotal"></span></div>
            </div>
            <h4 class="text-sm font-bold text-[var(--text-secondary)] uppercase mb-3 px-2">Список товаров</h4>
            <div id="detailItemsList" class="history-detail-scroll"></div>
        </div>
    </div>

    <!-- ACTIONS -->
    <div class="action-bar">
        <button id="btn-action-calc" onclick="sendCalc()" class="btn-main w-full py-4 text-lg shadow-xl">Рассчитать</button>
        <button id="btn-action-order" onclick="sendOrder()" class="btn-main w-full py-4 text-lg shadow-xl hidden">Оформить заказ</button>
        <button id="btn-action-search" onclick="sendSearch()" class="btn-main w-full py-4 text-lg shadow-xl hidden">Найти</button>
        <button id="btn-action-history" class="btn-main w-full py-4 text-lg shadow-xl hidden" style="opacity: 0; pointer-events: none;">.</button>
    </div>

    <!-- NAV -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('calc')"><i class="fas fa-calculator"></i><span>Калькулятор</span></div>
        <div class="nav-item" onclick="switchTab('order')"><i class="fas fa-shopping-bag"></i><span>Выкуп</span></div>
        <div class="nav-item" onclick="switchTab('search')"><i class="fas fa-search"></i><span>Поиск</span></div>
        <div class="nav-item" onclick="switchTab('history')"><i class="fas fa-history"></i><span>История</span></div>
    </div>

    <script>
        const IMGBB_KEY = '412d2791dd8620104d0849b745f489e0'; 
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#050505');
        tg.setBackgroundColor('#050505');
        const RATE_MULTIPLIER = 13; 
        
        let currentTab = 'calc';
        let orderItems = [];
        let searchItems = [];
        let deliveryType = 'grey'; 
        let historyDataCache = [];

        // --- WRAPPERS FOR CLOUD STORAGE ---
        const cloudStorage = {
            getItem: (key) => new Promise((resolve) => {
                tg.CloudStorage.getItem(key, (err, value) => resolve(!err ? value : null));
            }),
            setItem: (key, value) => new Promise((resolve, reject) => {
                tg.CloudStorage.setItem(key, value, (err, stored) => err ? reject(err) : resolve(stored));
            }),
            removeItem: (key) => new Promise((resolve, reject) => {
                tg.CloudStorage.removeItem(key, (err, deleted) => err ? reject(err) : resolve(deleted));
            })
        };

        // --- HISTORY LOGIC ---
        async function getHistoryIndex() {
            const indexStr = await cloudStorage.getItem('nws_history_idx');
            if (!indexStr) return [];
            try { return JSON.parse(indexStr); } catch (e) { return []; }
        }

        async function addToHistoryV2(dataObj) {
            try {
                // OPTIMIZE DATA SIZE FOR STORAGE
                // Remove imgUrls from individual items if object is large to prevent error
                // We keep 'images' array which has preview images.
                // We make a copy to not affect the actual data being sent to bot/displayed now
                let storageObj = JSON.parse(JSON.stringify(dataObj));
                
                // Estimate size
                if (JSON.stringify(storageObj).length > 3500) {
                     // Remove detail images from items list in history storage to save space
                     if(storageObj.itemsData) {
                         storageObj.itemsData = storageObj.itemsData.map(i => {
                             const { imgUrls, ...rest } = i; 
                             return rest; 
                         });
                     }
                }

                const id = Date.now().toString();
                const key = `nws_ord_${id}`;
                const index = await getHistoryIndex();

                await cloudStorage.setItem(key, JSON.stringify(storageObj));
                index.unshift(key);
                
                if (index.length > 20) {
                    const keysToRemove = index.slice(20);
                    for (const k of keysToRemove) { await cloudStorage.removeItem(k); }
                    index.length = 20; 
                }
                
                await cloudStorage.setItem('nws_history_idx', JSON.stringify(index));
            } catch (e) { console.error("History save error:", e); }
        }

        async function loadFullHistory() {
            const index = await getHistoryIndex();
            if (!index || index.length === 0) return [];
            
            // Sequential loading to be safe
            const historyItems = [];
            for (const key of index) {
                const res = await cloudStorage.getItem(key);
                if (res) {
                    try { historyItems.push(JSON.parse(res)); } catch (e) {}
                }
            }
            return historyItems;
        }

        // --- UI LOGIC ---
        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('open');
        }
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('open');
        }

        function openHistoryDetails(index) {
            const item = historyDataCache[index];
            if(!item) return;

            document.getElementById('detailTitle').innerText = item.title;
            document.getElementById('detailDate').innerText = item.date;
            document.getElementById('detailDelivery').innerText = item.delivery || 'Не указано';
            document.getElementById('detailTotal').innerText = item.price || '0 ₽';

            const listContainer = document.getElementById('detailItemsList');
            listContainer.innerHTML = '';

            if(item.itemsData && item.itemsData.length > 0) {
                item.itemsData.forEach(prod => {
                    let imgsHtml = '';
                    if(prod.imgUrls && prod.imgUrls.length > 0) {
                        imgsHtml = `<div class="detail-item-imgs">
                            ${prod.imgUrls.map(url => `<img src="${url}" class="detail-item-img" onclick="openLightbox('${url}')">`).join('')}
                        </div>`;
                    }
                    const priceHtml = prod.price ? `<div class="detail-item-price">${formatPrice(Math.ceil((parseFloat(prod.price)+30)*((item.delivery && item.delivery.includes('Белая') ? 1.1 : 1.05)) * 13))} ₽ (${prod.price} ¥)</div>` : '';
                    const html = `
                        <div class="detail-item-card">
                            <div class="detail-item-header">
                                <div class="detail-item-link">${prod.link || prod.comment || 'Товар'}</div>
                                ${priceHtml}
                            </div>
                            ${imgsHtml}
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', html);
                });
            } else {
                listContainer.innerHTML = '<div class="text-center text-gray-500 py-4">Нет списка товаров</div>';
            }
            document.getElementById('historyDetailSheet').classList.add('open');
        }

        function closeHistoryDetails(event) {
            if (!event || event.target === document.getElementById('historyDetailSheet') || event.target.classList.contains('sheet-handle')) {
                document.getElementById('historyDetailSheet').classList.remove('open');
            }
        }

        function formatPrice(num) {
            if(!num) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        async function compressImage(file, maxWidth = 1024, maxHeight = 1024, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                    }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, file.type, quality);
                };
                img.onerror = reject;
            });
        }

        function setDeliveryType(type) {
            deliveryType = type;
            document.querySelectorAll('.option-box').forEach(el => el.classList.remove('active'));
            document.getElementById(`del-${type}`).classList.add('active');
            orderItems.forEach(item => updateOrderItem(item.id, 'price', item.price, true));
        }

        let currentBox = { type: '', price: 0, l:0, w:0, h:0 };
        let hasCrate = false;

        function openBoxSheet() { document.getElementById('boxSheet').classList.add('open'); }
        function closeBoxSheet(event) {
            if (!event || event.target === document.getElementById('boxSheet') || event.target.classList.contains('sheet-handle')) {
                document.getElementById('boxSheet').classList.remove('open');
            }
        }

        function toggleCrate() {
            hasCrate = !hasCrate;
            const el = document.getElementById('crateOption');
            if(hasCrate) el.classList.add('active'); else el.classList.remove('active');
            updateCalc();
        }

        function selectBox(type, price, desc) {
            currentBox.type = type; currentBox.price = price;
            const triggerText = document.getElementById('selectedBoxName');
            const descEl = document.getElementById('boxDesc');
            const customDiv = document.getElementById('customDims');
            document.querySelectorAll('.sheet-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            if (type === 'custom') {
                triggerText.innerText = "Свой размер";
                descEl.classList.add('hidden'); customDiv.classList.remove('hidden');
            } else {
                triggerText.innerText = type;
                descEl.classList.remove('hidden'); descEl.innerText = desc;
                customDiv.classList.add('hidden');
                const sizes = {'Mini': [23,17,13], 'Small': [36,26,14], 'Large': [40,29,16], 'X-Large': [37,29,28]};
                if(sizes[type]) [currentBox.l, currentBox.w, currentBox.h] = sizes[type];
            }
            updateCalc();
            document.getElementById('boxSheet').classList.remove('open');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-action-calc').classList.add('hidden');
            document.getElementById('btn-action-order').classList.add('hidden');
            document.getElementById('btn-action-search').classList.add('hidden');
            document.getElementById('btn-action-history').classList.add('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
            if(tab !== 'history') document.getElementById(`btn-action-${tab}`).classList.remove('hidden');
            const tabs = ['calc', 'order', 'search', 'history'];
            document.querySelectorAll('.nav-item')[tabs.indexOf(tab)].classList.add('active');
            currentTab = tab;
            if(tab === 'order' && orderItems.length === 0) addOrderItem();
            if(tab === 'search' && searchItems.length === 0) addSearchItem();
            if(tab === 'history') renderHistory();
        }

        function updateCalc() {
            const priceEl = document.getElementById('totalPrice');
            let price = (currentBox.type === 'custom') ? 0 : currentBox.price;
            if (price > 0 && hasCrate) price += 299;
            priceEl.innerText = formatPrice(price);
        }

        function sendCalc() {
            try {
                if (!currentBox.type) return alert("Выберите упаковку!");
                if (currentBox.type === 'custom') {
                    const l = document.getElementById('dimL').value;
                    const w = document.getElementById('dimW').value;
                    const h = document.getElementById('dimH').value;
                    const weight = document.getElementById('weight').value;
                    if (!l || !w || !h || !weight) return alert("Введите габариты и вес!");
                }
                let data = { type: 'calc', packPrice: document.getElementById('totalPrice').innerText, hasCrate: hasCrate };
                if (currentBox.type === 'custom') {
                    data.boxName = 'Свой размер'; data.l = document.getElementById('dimL').value;
                    data.w = document.getElementById('dimW').value; data.h = document.getElementById('dimH').value;
                    data.weight = document.getElementById('weight').value;
                } else {
                    data.boxName = `Коробка ${currentBox.type}`;
                    data.l = currentBox.l; data.w = currentBox.w; data.h = currentBox.h;
                }
                tg.sendData(JSON.stringify(data));
            } catch (e) { alert("Ошибка: " + e.message); }
        }

        function updateItemNumbers(type) {
            const listId = type === 'order' ? 'orderItemsList' : 'searchItemsList';
            const prefix = type === 'order' ? 'Товар' : 'Позиция';
            const labels = document.getElementById(listId).querySelectorAll('.section-label');
            labels.forEach((label, index) => { label.innerText = `${prefix} №${index + 1}`; });
        }

        function addOrderItem() {
            const id = Date.now();
            const html = `
                <div id="order-item-${id}" class="card p-5 relative animate-fade-in">
                    <button onclick="removeElement('order-item-${id}', 'order')" class="delete-btn absolute top-4 right-4 text-[var(--danger-color)] p-2 hover:bg-white/10 rounded-full transition"><i class="fas fa-times text-xl"></i></button>
                    <label class="section-label">Товар</label> 
                    <input type="text" class="mb-4" placeholder="Ссылка на товар" onchange="updateOrderItem(${id}, 'link', this.value)">
                    <div class="flex gap-4 mb-4" style="height: 58px;">
                        <div class="w-1/2 h-full"><input type="number" placeholder="Цена (¥)" style="height: 100%;" oninput="updateOrderItem(${id}, 'price', this.value)"></div>
                        <div class="w-1/2 h-full"><div id="res-rub-${id}" class="price-result-box">0 ₽</div></div>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center" id="preview-area-${id}">
                        <label class="photo-btn"><i class="fas fa-camera"></i><input type="file" accept="image/*" multiple class="hidden" onchange="handleImageUpload(this, ${id}, 'order')"></label>
                    </div>
                </div>
            `;
            document.getElementById('orderItemsList').insertAdjacentHTML('beforeend', html);
            orderItems.push({ id, link: '', price: 0, resYuan: 0, imgUrls: [] });
            updateDeleteButtons('order'); updateItemNumbers('order');
        }

        function updateOrderItem(id, field, value, forceUpdate = false) {
            const item = orderItems.find(i => i.id === id);
            if (!item) return;
            if (field === 'price' || forceUpdate) {
                const val = parseFloat(value) || 0; item.price = val;
                const resBox = document.getElementById(`res-rub-${id}`);
                if (val === 0) {
                     resBox.innerText = `0 ₽`; resBox.classList.remove('active-price'); item.resYuan = 0;
                } else {
                    const commission = deliveryType === 'white' ? 0.10 : 0.05;
                    const priceWithShipping = val + 30;
                    const commissionSum = priceWithShipping * commission;
                    const rub = Math.ceil((priceWithShipping + commissionSum) * RATE_MULTIPLIER);
                    item.resYuan = val; resBox.innerText = `${formatPrice(rub)} ₽`; resBox.classList.add('active-price');
                }
            } else { item[field] = value; }
        }

        async function sendOrder() {
            try {
                if (orderItems.length === 0) return alert("Пустой заказ!");
                
                let totalRub = 0;
                orderItems.forEach(i => {
                    const val = i.price || 0;
                    if(val > 0) {
                        const comm = deliveryType === 'white' ? 0.10 : 0.05;
                        totalRub += Math.ceil(((val + 30) + (val + 30) * comm) * RATE_MULTIPLIER);
                    }
                });

                const historyImages = orderItems.map(item => item.imgUrls[0]).filter(url => !!url);
                const historyObj = {
                    title: 'Заказ на выкуп', date: new Date().toLocaleString('ru-RU'),
                    delivery: deliveryType === 'white' ? 'Белая' : 'Серая',
                    price: totalRub > 0 ? `${formatPrice(totalRub)} ₽` : 'Цена не указана',
                    itemsData: orderItems, images: historyImages
                };
                
                await addToHistoryV2(historyObj);

                // --- DATA REDUCTION FOR BOT ---
                let payload = { type: 'order', items: orderItems, deliveryType: deliveryType === 'white' ? 'Белая (12-15 дн)' : 'Серая (20-35 дн)' };
                let json = JSON.stringify(payload);
                
                if (json.length > 3500) {
                    // Aggressive reduction: Remove images from payload if too big
                    payload.items = payload.items.map(i => {
                        const { imgUrls, ...rest } = i; 
                        return { ...rest, imgUrls: [] }; // No images to bot for huge order
                    });
                }
                
                tg.sendData(JSON.stringify(payload));
            } catch (e) { alert("Ошибка: " + e.message); }
        }

        function addSearchItem() {
            const id = Date.now();
            const html = `
                <div id="search-item-${id}" class="card p-5 relative animate-fade-in">
                    <button onclick="removeElement('search-item-${id}', 'search')" class="delete-btn absolute top-4 right-4 text-[var(--danger-color)] p-2 hover:bg-white/10 rounded-full transition"><i class="fas fa-times text-xl"></i></button>
                    <label class="section-label">Позиция</label>
                    <textarea class="mb-4 h-28 resize-none" placeholder="Комментарий" onchange="updateSearchItem(${id}, 'comment', this.value)"></textarea>
                    <div class="flex flex-wrap gap-2 items-center" id="search-preview-area-${id}">
                        <label class="photo-btn"><i class="fas fa-camera"></i><input type="file" accept="image/*" multiple class="hidden" onchange="handleImageUpload(this, ${id}, 'search')"></label>
                    </div>
                </div>
            `;
            document.getElementById('searchItemsList').insertAdjacentHTML('beforeend', html);
            searchItems.push({ id, comment: '', imgUrls: [] });
            updateDeleteButtons('search'); updateItemNumbers('search');
        }

        function updateSearchItem(id, field, value) {
            const item = searchItems.find(i => i.id === id); if (item) item[field] = value;
        }

        function removeElement(elementId, type) {
            const list = type === 'order' ? orderItems : searchItems;
            if (list.length <= 1) return;
            document.getElementById(elementId).remove();
            const id = parseInt(elementId.split('-').pop());
            if (type === 'order') orderItems = orderItems.filter(i => i.id !== id);
            else searchItems = searchItems.filter(i => i.id !== id);
            updateDeleteButtons(type); updateItemNumbers(type);
        }

        function updateDeleteButtons(type) {
            const list = type === 'order' ? orderItems : searchItems;
            const containerId = type === 'order' ? 'orderItemsList' : 'searchItemsList';
            const buttons = document.querySelectorAll(`#${containerId} .delete-btn`);
            buttons.forEach(btn => { btn.style.display = list.length > 1 ? 'block' : 'none'; });
        }

        async function handleImageUpload(input, id, type) {
            let files = Array.from(input.files); if (!files.length) return;
            if (files.length >= 10) { alert("Выбрано 10 или более фото. Будут загружены последние 9."); files = files.slice(-9); }
            const previewArea = document.getElementById(type === 'order' ? `preview-area-${id}` : `search-preview-area-${id}`);
            const btnLabel = previewArea.querySelector('label');
            for (let i = 0; i < files.length; i++) {
                const file = files[i]; const loadId = `load-${Date.now()}-${i}`;
                const loadingHtml = `<div id="${loadId}" class="photo-btn animate-pulse border-none"><i class="fas fa-spinner fa-spin text-white"></i></div>`;
                btnLabel.insertAdjacentHTML('beforebegin', loadingHtml);
                try {
                    const compressedBlob = await compressImage(file);
                    const formData = new FormData();
                    formData.append("image", compressedBlob, file.name);
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
                    const data = await response.json();
                    document.getElementById(loadId).remove();
                    if (data.success) {
                        const imgUrl = data.data.url; const thumbUrl = data.data.thumb.url;
                        const list = type === 'order' ? orderItems : searchItems;
                        const item = list.find(i => i.id === id);
                        if (item) item.imgUrls.push(imgUrl);
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'preview-item';
                        imgDiv.innerHTML = `<img src="${thumbUrl}" onclick="openLightbox('${imgUrl}')"><div class="preview-remove" onclick="removeImage(${id}, '${imgUrl}', '${type}', this)"><i class="fas fa-times"></i></div>`;
                        btnLabel.insertAdjacentElement('beforebegin', imgDiv);
                    } else { alert("Ошибка загрузки фото"); }
                } catch (error) {
                    if(document.getElementById(loadId)) document.getElementById(loadId).remove();
                    alert("Ошибка сети");
                }
            }
            input.value = '';
        }

        function removeImage(itemId, imgUrl, type, btnElement) {
            const list = type === 'order' ? orderItems : searchItems;
            const item = list.find(i => i.id === itemId);
            if (item) item.imgUrls = item.imgUrls.filter(url => url !== imgUrl);
            btnElement.parentElement.remove();
        }

        async function sendSearch() {
            try {
                if (searchItems.length === 0) return alert("Пустой поиск!");

                const historyImages = searchItems.map(item => item.imgUrls[0]).filter(url => !!url);
                const historyObj = {
                    title: 'Заявка на поиск', date: new Date().toLocaleString('ru-RU'),
                    delivery: 'Поиск', price: '', itemsData: searchItems, images: historyImages
                };
                
                await addToHistoryV2(historyObj);

                let payload = { type: 'search', items: searchItems };
                let json = JSON.stringify(payload);
                if (json.length > 3500) {
                    // Strip images for bot if too large
                    payload.items = payload.items.map(i => ({ ...i, imgUrls: [] }));
                }

                tg.sendData(JSON.stringify(payload));
            } catch (e) { alert("Ошибка: " + e.message); }
        }

        async function renderHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = '<div style="text-align:center; margin-top:20px; color:#666;">Загрузка...</div>';
            
            const history = await loadFullHistory();
            historyDataCache = history; 
            container.innerHTML = '';
            
            if (history.length === 0) { container.innerHTML = '<div class="empty-history">История заказов пуста</div>'; return; }
            
            history.forEach((item, index) => {
                let imagesHtml = '';
                if (item.images && item.images.length > 0) {
                    imagesHtml = `<div class="history-imgs">
                            ${item.images.map(url => `<img src="${url}" class="history-img-thumb" onclick="openLightbox('${url}'); event.stopPropagation();">`).join('')}
                        </div>`;
                }
                const html = `
                    <div class="history-item" onclick="openHistoryDetails(${index})">
                        <div class="history-header"><span class="history-type">${item.title}</span><span class="history-date">${item.date}</span></div>
                        <div class="history-details">${item.itemsData ? item.itemsData.length : 0} позиций ${item.delivery ? '• ' + item.delivery : ''}</div>
                        ${item.price ? `<div class="history-price">${item.price}</div>` : ''}
                        ${imagesHtml}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }
        
        document.body.style.backgroundColor = "var(--bg-color)";
        document.getElementById('selectedBoxName').innerText = "Выберите упаковку";
    </script>
</body>
</html>
