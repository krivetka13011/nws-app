<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NWS Logistics</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: rgba(20, 20, 25, 0.7);
            --text-color: #ffffff;
            --text-secondary: #a1a1aa;
            
            /* Неоновые акценты */
            --primary-color: #6366f1; /* Индиго */
            --accent-glow: 0 0 15px rgba(99, 102, 241, 0.3);
            --border-color: rgba(99, 102, 241, 0.3);
            --border-active: #818cf8;
            
            --danger-color: #ef4444;
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            overscroll-behavior: none;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #050505 70%);
            color: var(--text-color);
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 0; 
        }

        /* --- СТИЛИЗАЦИЯ КАРТОЧЕК (Neon Glass) --- */
        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        /* --- КНОПКИ --- */
        .btn-main {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: #ffffff;
            border-radius: 16px;
            font-weight: 600;
            font-size: 17px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-main:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(79, 70, 229, 0.2);
        }

        .btn-secondary {
            background-color: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--border-color);
            color: #818cf8;
            border-radius: 16px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-secondary:active {
            background-color: rgba(99, 102, 241, 0.2);
            border-color: var(--border-active);
        }

        /* --- ПОЛЯ ВВОДА --- */
        input, textarea {
            background-color: rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            /* ИСПРАВЛЕНО: Стандартный отступ, как у кнопок доставки (20px) */
            padding: 18px 20px;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-secondary);
            font-weight: 400;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--border-active);
            box-shadow: var(--accent-glow);
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Результат цены (в стиле input) */
        .price-result-box {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-secondary);
        }
        .price-result-box.active-price {
            color: #fff;
            border-color: var(--border-active);
            box-shadow: var(--accent-glow);
            text-shadow: 0 0 10px rgba(129, 140, 248, 0.5);
        }

        /* --- ВЫБОР (SELECT) --- */
        .custom-select-trigger {
            background-color: rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        /* --- ОПЦИИ (Обрешетка / Доставка) --- */
        .option-box {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .option-box.active {
            background-color: rgba(99, 102, 241, 0.15);
            border-color: var(--border-active);
            box-shadow: var(--accent-glow);
        }
        
        /* Flex для обрешетки */
        .crate-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .option-title {
            color: #fff;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }
        .option-sub {
            color: var(--text-secondary);
            font-size: 13px;
        }
        .option-price {
            color: var(--border-active);
            font-weight: bold;
        }

        /* --- BOTTOM SHEET (Модалка) --- */
        .sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            backdrop-filter: blur(8px);
        }
        .sheet-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .sheet-content {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background-color: #121217;
            border-top: 1px solid var(--border-active);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            z-index: 101;
            padding: 24px 16px 40px 16px;
            transition: bottom 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 -5px 30px rgba(99, 102, 241, 0.2);
        }
        .sheet-overlay.open .sheet-content {
            bottom: 0;
        }
        
        .sheet-handle {
            width: 40px;
            height: 4px;
            background-color: #3f3f46;
            border-radius: 2px;
            margin: 0 auto 20px auto;
        }

        .sheet-option {
            padding: 20px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 17px;
        }
        .sheet-option:last-child {
            border-bottom: none;
        }
        .sheet-option:active {
            background-color: rgba(255,255,255,0.05);
        }
        .sheet-option.selected {
            color: #818cf8;
            font-weight: 600;
        }

        /* --- ЗАГОЛОВКИ --- */
        .section-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #818cf8; /* Неоновый цвет заголовков */
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-left: 4px;
            text-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
        }
        
        h2 {
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        /* --- ТАБЫ --- */
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ФИКСИРОВАННЫЕ ЭЛЕМЕНТЫ --- */
        .action-bar {
            position: fixed;
            bottom: 85px; /* Над навигацией */
            left: 0;
            width: 100%;
            padding: 0 16px;
            z-index: 40;
            pointer-events: none; /* Чтобы клики проходили сквозь пустоту */
        }
        .action-bar button {
            pointer-events: auto;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }

        /* --- НАВИГАЦИЯ (NEON STYLE) --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 16px;
            right: 16px;
            height: 60px;
            background-color: rgba(20, 20, 25, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-secondary);
            width: 33%;
            height: 100%;
            transition: all 0.3s;
            position: relative;
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 3px;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            color: #fff;
        }
        .nav-item.active i {
            color: #818cf8;
            filter: drop-shadow(0 0 8px rgba(129, 140, 248, 0.6));
            transform: translateY(-2px);
        }

        /* --- ФОТО --- */
        .photo-btn {
            width: 80px;
            height: 80px;
            border-radius: 18px;
            background-color: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px dashed var(--border-color);
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .photo-btn:active {
            border-color: var(--border-active);
            background-color: rgba(99, 102, 241, 0.1);
        }
        .photo-btn i { color: var(--text-secondary); font-size: 24px; }

        .preview-item {
            width: 80px;
            height: 80px;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
            flex-shrink: 0;
        }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-remove {
            position: absolute;
            top: 4px; right: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer;
            backdrop-filter: blur(2px);
        }

        .scroll-spacer { height: 200px; width: 100%; flex-shrink: 0; }
    </style>
</head>
<body class="p-4">

    <!-- TAB 1: CALCULATOR -->
    <div id="tab-calc" class="tab-content active">
        <h2 class="text-3xl font-bold mb-6 px-2 text-white">Калькулятор</h2>
        
        <div class="space-y-5">
            <div class="card p-5">
                <label class="section-label">Упаковка</label>
                
                <div class="custom-select-trigger mb-4" onclick="openBoxSheet()">
                    <span id="selectedBoxName" class="font-medium">Выберите упаковку</span>
                    <i class="fas fa-chevron-down text-gray-400"></i>
                </div>
                
                <!-- CRATE TOGGLE -->
                <div class="option-box crate-row" id="crateOption" onclick="toggleCrate()">
                    <span class="option-title">Обрешетка</span>
                    <span class="option-price">+299 ₽</span>
                </div>

                <div id="boxDesc" class="mt-4 text-[15px] leading-relaxed text-[var(--text-secondary)] bg-[rgba(0,0,0,0.3)] p-4 rounded-2xl hidden border border-[var(--border-color)]"></div>
            </div>

            <div id="customDims" class="hidden animate-fade-in">
                <div class="card p-5">
                    <label class="section-label">Габариты и Вес</label>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input type="number" id="dimL" placeholder="Длина (см)" class="text-center" oninput="updateCalc()">
                        <input type="number" id="dimW" placeholder="Ширина (см)" class="text-center" oninput="updateCalc()">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="dimH" placeholder="Высота (см)" class="text-center" oninput="updateCalc()">
                        <input type="number" id="weight" placeholder="Вес (кг)" class="text-center" oninput="updateCalc()">
                    </div>
                </div>
            </div>

            <div class="card p-6 text-center" style="background: linear-gradient(135deg, rgba(79, 70, 229, 0.2) 0%, rgba(55, 48, 163, 0.2) 100%); border-color: var(--border-active);">
                <span class="text-indigo-200 text-sm font-medium uppercase tracking-widest" style="text-shadow: 0 0 10px rgba(99, 102, 241, 0.5);">Ориентировочно</span>
                <div class="text-5xl font-extrabold mt-3 tracking-tight text-white" style="text-shadow: 0 0 20px rgba(129, 140, 248, 0.6);">
                    <span id="totalPrice">0</span> ₽
                </div>
            </div>
            
            <p class="text-[12px] text-center text-[var(--text-secondary)] px-4 mt-2 opacity-60">
                *Итоговая стоимость фиксируется на складе.
            </p>
        </div>
        <div class="scroll-spacer"></div>
    </div>

    <!-- TAB 2: ORDER (BUYOUT) -->
    <div id="tab-order" class="tab-content">
        <h2 class="text-3xl font-bold mb-6 px-2 text-white">Выкуп</h2>
        
        <div class="card p-5 mb-6">
            <label class="section-label">Тип доставки</label>
            <div class="grid grid-cols-1 gap-3">
                <div class="option-box active" onclick="setDeliveryType('grey')" id="del-grey">
                    <div class="option-title">Серая доставка</div>
                    <div class="option-sub">20-35 дней • Комиссия 5%</div>
                </div>
                <div class="option-box" onclick="setDeliveryType('white')" id="del-white">
                    <div class="option-title">Белая доставка</div>
                    <div class="option-sub">12-15 дней • Комиссия 10%</div>
                </div>
            </div>
        </div>

        <div id="orderItemsList" class="space-y-4"></div>
        
        <button onclick="addOrderItem()" class="w-full mt-6 py-4 btn-secondary gap-2 border-dashed">
            <i class="fas fa-plus text-lg"></i> 
            <span class="text-lg">Добавить товар</span>
        </button>

        <div class="scroll-spacer"></div>
    </div>

    <!-- TAB 3: SEARCH -->
    <div id="tab-search" class="tab-content">
        <h2 class="text-3xl font-bold mb-6 px-2 text-white">Поиск</h2>
        <div id="searchItemsList" class="space-y-4"></div>
        <button onclick="addSearchItem()" class="w-full mt-6 py-4 btn-secondary gap-2 border-dashed">
            <i class="fas fa-plus text-lg"></i> 
            <span class="text-lg">Добавить позицию</span>
        </button>

        <div class="scroll-spacer"></div>
    </div>

    <!-- BOTTOM SHEET -->
    <div class="sheet-overlay" id="boxSheet" onclick="closeBoxSheet(event)">
        <div class="sheet-content" onclick="event.stopPropagation()">
            <div class="sheet-handle" onclick="closeBoxSheet()"></div>
            <h3 class="text-xl font-bold mb-6 px-2 text-white">Выберите размер</h3>
            
            <div class="sheet-option" onclick="selectBox('Mini', 679, 'Вещи (футболка, сумка, ремень, носки)')">
                <div class="flex flex-col">
                    <span class="text-lg font-medium text-white">Mini</span>
                    <span class="text-sm text-[var(--text-secondary)] mt-1">23x17x13 см, до 0.6 кг</span>
                </div>
                <span class="text-indigo-400 font-bold text-lg">679 ₽</span>
            </div>
            
            <div class="sheet-option" onclick="selectBox('Small', 1562, 'Пара обуви в коробке')">
                 <div class="flex flex-col">
                    <span class="text-lg font-medium text-white">Small</span>
                    <span class="text-sm text-[var(--text-secondary)] mt-1">36x26x14 см, до 1.5 кг</span>
                </div>
                <span class="text-indigo-400 font-bold text-lg">1562 ₽</span>
            </div>
            
            <div class="sheet-option" onclick="selectBox('Large', 2411, 'Пара обуви в коробке + несколько вещей')">
                 <div class="flex flex-col">
                    <span class="text-lg font-medium text-white">Large</span>
                    <span class="text-sm text-[var(--text-secondary)] mt-1">40x29x16 см, до 2.5 кг</span>
                </div>
                <span class="text-indigo-400 font-bold text-lg">2411 ₽</span>
            </div>
            
            <div class="sheet-option" onclick="selectBox('X-Large', 3489, 'Две пары обуви в коробке + несколько вещей')">
                 <div class="flex flex-col">
                    <span class="text-lg font-medium text-white">X-Large</span>
                    <span class="text-sm text-[var(--text-secondary)] mt-1">37x29x28 см, до 3.5 кг</span>
                </div>
                <span class="text-indigo-400 font-bold text-lg">3489 ₽</span>
            </div>
            
            <div class="sheet-option" onclick="selectBox('custom', 0, 'Расчет по объемному весу')">
                <span class="text-lg text-white">Свой размер</span>
                <span class="text-[var(--text-secondary)] text-sm">Калькулятор</span>
            </div>
        </div>
    </div>

    <!-- FIXED ACTION BUTTONS -->
    <div class="action-bar">
        <button id="btn-action-calc" onclick="sendCalc()" class="btn-main w-full py-4 text-lg shadow-xl">Рассчитать</button>
        <button id="btn-action-order" onclick="sendOrder()" class="btn-main w-full py-4 text-lg shadow-xl hidden">Оформить заказ</button>
        <button id="btn-action-search" onclick="sendSearch()" class="btn-main w-full py-4 text-lg shadow-xl hidden">Найти</button>
    </div>

    <!-- BOTTOM NAVIGATION (FLOATING) -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('calc')">
            <i class="fas fa-calculator"></i>
            <span>Калькулятор</span>
        </div>
        <div class="nav-item" onclick="switchTab('order')">
            <i class="fas fa-shopping-bag"></i>
            <span>Выкуп</span>
        </div>
        <div class="nav-item" onclick="switchTab('search')">
            <i class="fas fa-search"></i>
            <span>Поиск</span>
        </div>
    </div>

    <script>
        const IMGBB_KEY = '412d2791dd8620104d0849b745f489e0'; 
        
        const tg = window.Telegram.WebApp;
        tg.expand();
        // Устанавливаем цвета хедера под тему
        tg.setHeaderColor('#050505');
        tg.setBackgroundColor('#050505');

        const RATE_MULTIPLIER = 13; 
        
        let currentTab = 'calc';
        let orderItems = [];
        let searchItems = [];
        let deliveryType = 'grey'; 

        async function compressImage(file, maxWidth = 1024, maxHeight = 1024, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, file.type, quality);
                };
                img.onerror = reject;
            });
        }

        function setDeliveryType(type) {
            deliveryType = type;
            document.querySelectorAll('.option-box').forEach(el => el.classList.remove('active'));
            document.getElementById(`del-${type}`).classList.add('active');
            orderItems.forEach(item => {
                updateOrderItem(item.id, 'price', item.price, true);
            });
        }

        let currentBox = { type: '', price: 0, l:0, w:0, h:0 };
        let hasCrate = false;

        function openBoxSheet() {
            document.getElementById('boxSheet').classList.add('open');
        }

        function closeBoxSheet(event) {
            if (!event || event.target === document.getElementById('boxSheet') || event.target.classList.contains('sheet-handle')) {
                document.getElementById('boxSheet').classList.remove('open');
            }
        }

        function toggleCrate() {
            hasCrate = !hasCrate;
            const el = document.getElementById('crateOption');
            if(hasCrate) el.classList.add('active');
            else el.classList.remove('active');
            updateCalc();
        }

        function selectBox(type, price, desc) {
            currentBox.type = type;
            currentBox.price = price;

            const triggerText = document.getElementById('selectedBoxName');
            const descEl = document.getElementById('boxDesc');
            const customDiv = document.getElementById('customDims');
            
            document.querySelectorAll('.sheet-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            if (type === 'custom') {
                triggerText.innerText = "Свой размер";
                descEl.classList.remove('hidden');
                descEl.innerText = desc;
                customDiv.classList.remove('hidden');
            } else {
                triggerText.innerText = type; 
                descEl.classList.remove('hidden');
                descEl.innerText = desc;
                customDiv.classList.add('hidden');
                
                const sizes = {'Mini': [23,17,13], 'Small': [36,26,14], 'Large': [40,29,16], 'X-Large': [37,29,28]};
                if(sizes[type]) {
                    [currentBox.l, currentBox.w, currentBox.h] = sizes[type];
                }
            }

            updateCalc();
            document.getElementById('boxSheet').classList.remove('open');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-action-calc').classList.add('hidden');
            document.getElementById('btn-action-order').classList.add('hidden');
            document.getElementById('btn-action-search').classList.add('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`btn-action-${tab}`).classList.remove('hidden');
            const navIndex = ['calc', 'order', 'search'].indexOf(tab);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            currentTab = tab;
            if(tab === 'order' && orderItems.length === 0) addOrderItem();
            if(tab === 'search' && searchItems.length === 0) addSearchItem();
        }

        function updateCalc() {
            const priceEl = document.getElementById('totalPrice');
            let price = 0;
            
            if (currentBox.type === 'custom') {
                price = 0;
            } else {
                price = currentBox.price;
                if (price > 0 && hasCrate) {
                    price += 299;
                }
            }

            priceEl.innerText = price;
        }

        function sendCalc() {
            try {
                if (!currentBox.type) return alert("Выберите упаковку!");
                if (currentBox.type === 'custom') {
                    const l = document.getElementById('dimL').value;
                    const w = document.getElementById('dimW').value;
                    const h = document.getElementById('dimH').value;
                    const weight = document.getElementById('weight').value;
                    if (!l || !w || !h || !weight) return alert("Введите габариты и вес!");
                }
                
                let data = { 
                    type: 'calc', 
                    packPrice: document.getElementById('totalPrice').innerText,
                    hasCrate: hasCrate 
                };
                
                if (currentBox.type === 'custom') {
                    data.boxName = 'Свой размер';
                    data.l = document.getElementById('dimL').value;
                    data.w = document.getElementById('dimW').value;
                    data.h = document.getElementById('dimH').value;
                    data.weight = document.getElementById('weight').value;
                } else {
                    data.boxName = `Коробка ${currentBox.type}`;
                    data.l = currentBox.l; data.w = currentBox.w; data.h = currentBox.h;
                }
                tg.sendData(JSON.stringify(data));
            } catch (e) {
                alert("Ошибка: " + e.message);
            }
        }

        function updateItemNumbers(type) {
            const listId = type === 'order' ? 'orderItemsList' : 'searchItemsList';
            const prefix = type === 'order' ? 'Товар' : 'Позиция';
            const container = document.getElementById(listId);
            const labels = container.querySelectorAll('.section-label');
            labels.forEach((label, index) => {
                label.innerText = `${prefix} №${index + 1}`;
            });
        }

        function addOrderItem() {
            const id = Date.now();
            const html = `
                <div id="order-item-${id}" class="card p-5 relative animate-fade-in">
                    <button onclick="removeElement('order-item-${id}', 'order')" class="delete-btn absolute top-4 right-4 text-[var(--danger-color)] p-2 hover:bg-white/10 rounded-full transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <label class="section-label">Товар</label> 
                    <input type="text" class="mb-4" placeholder="Ссылка на товар" onchange="updateOrderItem(${id}, 'link', this.value)">
                    <div class="flex gap-4 mb-4" style="height: 58px;">
                        <div class="w-1/2 h-full">
                            <input type="number" placeholder="Цена (¥)" style="height: 100%;" oninput="updateOrderItem(${id}, 'price', this.value)">
                        </div>
                        <div class="w-1/2 h-full">
                            <div id="res-rub-${id}" class="price-result-box">0 ₽</div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center" id="preview-area-${id}">
                        <label class="photo-btn">
                            <i class="fas fa-camera"></i>
                            <input type="file" accept="image/*" multiple class="hidden" onchange="handleImageUpload(this, ${id}, 'order')">
                        </label>
                    </div>
                </div>
            `;
            document.getElementById('orderItemsList').insertAdjacentHTML('beforeend', html);
            orderItems.push({ id, link: '', price: 0, resYuan: 0, imgUrls: [] });
            updateDeleteButtons('order');
            updateItemNumbers('order');
        }

        function updateOrderItem(id, field, value, forceUpdate = false) {
            const item = orderItems.find(i => i.id === id);
            if (!item) return;

            if (field === 'price' || forceUpdate) {
                const val = parseFloat(value) || 0;
                item.price = val;
                
                const resBox = document.getElementById(`res-rub-${id}`);
                
                if (val === 0) {
                     resBox.innerText = `0 ₽`;
                     resBox.classList.remove('active-price');
                     item.resYuan = 0;
                } else {
                    const commission = deliveryType === 'white' ? 0.10 : 0.05;
                    const priceWithShipping = val + 30;
                    const commissionSum = priceWithShipping * commission;
                    const rub = Math.ceil((priceWithShipping + commissionSum) * RATE_MULTIPLIER);
                    
                    item.resYuan = val; 
                    resBox.innerText = `${rub} ₽`;
                    resBox.classList.add('active-price');
                }
            } else {
                item[field] = value;
            }
        }

        function sendOrder() {
            try {
                if (orderItems.length === 0) return alert("Пустой заказ!");
                const data = { 
                    type: 'order', 
                    items: orderItems,
                    deliveryType: deliveryType === 'white' ? 'Белая (12-15 дн)' : 'Серая (20-35 дн)'
                };
                tg.sendData(JSON.stringify(data));
            } catch (e) {
                alert("Ошибка: " + e.message);
            }
        }

        function addSearchItem() {
            const id = Date.now();
            const html = `
                <div id="search-item-${id}" class="card p-5 relative animate-fade-in">
                    <button onclick="removeElement('search-item-${id}', 'search')" class="delete-btn absolute top-4 right-4 text-[var(--danger-color)] p-2 hover:bg-white/10 rounded-full transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <label class="section-label">Позиция</label>
                    <textarea class="mb-4 h-28 resize-none" placeholder="Комментарий" onchange="updateSearchItem(${id}, 'comment', this.value)"></textarea>
                    <div class="flex flex-wrap gap-2 items-center" id="search-preview-area-${id}">
                        <label class="photo-btn">
                            <i class="fas fa-camera"></i>
                            <input type="file" accept="image/*" multiple class="hidden" onchange="handleImageUpload(this, ${id}, 'search')">
                        </label>
                    </div>
                </div>
            `;
            document.getElementById('searchItemsList').insertAdjacentHTML('beforeend', html);
            searchItems.push({ id, comment: '', imgUrls: [] });
            updateDeleteButtons('search');
            updateItemNumbers('search');
        }

        function updateSearchItem(id, field, value) {
            const item = searchItems.find(i => i.id === id);
            if (item) item[field] = value;
        }

        function removeElement(elementId, type) {
            const list = type === 'order' ? orderItems : searchItems;
            if (list.length <= 1) return;
            document.getElementById(elementId).remove();
            const id = parseInt(elementId.split('-').pop());
            if (type === 'order') {
                orderItems = orderItems.filter(i => i.id !== id);
            } else {
                searchItems = searchItems.filter(i => i.id !== id);
            }
            updateDeleteButtons(type);
            updateItemNumbers(type);
        }

        function updateDeleteButtons(type) {
            const list = type === 'order' ? orderItems : searchItems;
            const containerId = type === 'order' ? 'orderItemsList' : 'searchItemsList';
            const buttons = document.querySelectorAll(`#${containerId} .delete-btn`);
            buttons.forEach(btn => {
                btn.style.display = list.length > 1 ? 'block' : 'none';
            });
        }

        async function handleImageUpload(input, id, type) {
            const files = input.files;
            if (!files || files.length === 0) return;

            const previewArea = document.getElementById(type === 'order' ? `preview-area-${id}` : `search-preview-area-${id}`);
            const btnLabel = previewArea.querySelector('label');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const loadId = `load-${Date.now()}-${i}`;
                const loadingHtml = `<div id="${loadId}" class="photo-btn animate-pulse border-none"><i class="fas fa-spinner fa-spin text-white"></i></div>`;
                
                btnLabel.insertAdjacentHTML('beforebegin', loadingHtml);

                try {
                    const compressedBlob = await compressImage(file);
                    const formData = new FormData();
                    formData.append("image", compressedBlob, file.name);

                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                        method: "POST",
                        body: formData
                    });
                    
                    const data = await response.json();
                    document.getElementById(loadId).remove();

                    if (data.success) {
                        const imgUrl = data.data.url;
                        const thumbUrl = data.data.thumb.url;

                        const list = type === 'order' ? orderItems : searchItems;
                        const item = list.find(i => i.id === id);
                        if (item) item.imgUrls.push(imgUrl);

                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'preview-item';
                        imgDiv.innerHTML = `
                            <img src="${thumbUrl}">
                            <div class="preview-remove" onclick="removeImage(${id}, '${imgUrl}', '${type}', this)">
                                <i class="fas fa-times"></i>
                            </div>
                        `;
                        
                        btnLabel.insertAdjacentElement('beforebegin', imgDiv);
                    } else {
                        alert("Ошибка загрузки фото: " + (data.error ? data.error.message : 'Неизвестная ошибка'));
                    }
                } catch (error) {
                    if(document.getElementById(loadId)) document.getElementById(loadId).remove();
                    alert("Ошибка сети при загрузке фото");
                }
            }
            input.value = '';
        }

        function removeImage(itemId, imgUrl, type, btnElement) {
            const list = type === 'order' ? orderItems : searchItems;
            const item = list.find(i => i.id === itemId);
            if (item) {
                item.imgUrls = item.imgUrls.filter(url => url !== imgUrl);
            }
            btnElement.parentElement.remove();
        }

        function sendSearch() {
            try {
                if (searchItems.length === 0) return alert("Пустой поиск!");
                tg.sendData(JSON.stringify({ type: 'search', items: searchItems }));
            } catch (e) {
                alert("Ошибка: " + e.message);
            }
        }
        
        // Init
        document.body.style.backgroundColor = "var(--bg-color)";
        document.getElementById('selectedBoxName').innerText = "Выберите упаковку";
    </script>
</body>
</html>
