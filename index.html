<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NWS Logistics</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            /* Отступ снизу для фиксированных кнопок и меню */
            padding-bottom: 140px; 
            overflow-x: hidden;
        }

        /* Мягкие тени и скругления */
        .card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 20px;
        }

        .btn-main {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-radius: 16px;
            font-weight: 600;
            transition: transform 0.1s;
        }
        .btn-main:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background-color: transparent;
            border: 2px dashed var(--tg-theme-button-color);
            color: var(--tg-theme-button-color);
            border-radius: 16px;
            font-weight: 600;
        }

        /* Inputs */
        input, select, textarea {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            border: none;
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--tg-theme-button-color);
        }

        /* Animations */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Bottom Fixed Areas */
        .action-bar {
            position: fixed;
            bottom: 65px; /* Выше навигации */
            left: 0;
            width: 100%;
            padding: 10px 16px;
            background: linear-gradient(to top, var(--tg-theme-bg-color) 80%, transparent);
            z-index: 40;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: var(--tg-theme-bg-color);
            border-top: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--tg-theme-hint-color);
            width: 33%;
            height: 100%;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--tg-theme-button-color);
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Custom Select Styling */
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: '\f078';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tg-theme-hint-color);
            pointer-events: none;
        }
        select {
            appearance: none;
            -webkit-appearance: none;
        }

        /* Photo Upload Button */
        .photo-btn {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background-color: #f0f0f0; /* Slightly darker than input for contrast */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .photo-btn:active {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body class="p-4">

    <!-- TAB 1: CALCULATOR -->
    <div id="tab-calc" class="tab-content active">
        <h2 class="text-2xl font-bold mb-6 px-1">Калькулятор</h2>
        
        <div class="space-y-6">
            <!-- Box Selection -->
            <div class="card p-4">
                <label class="block text-xs font-bold text-[var(--tg-theme-hint-color)] mb-2 uppercase tracking-wide">Выберите упаковку</label>
                <div class="select-wrapper">
                    <select id="boxType" class="w-full bg-white text-lg font-medium p-4 rounded-xl shadow-sm" onchange="updateCalc()">
                        <!-- Цены и размеры обновлены под логику -->
                        <option value="XS" data-price="900" data-desc="Мелкие аксессуары, чехлы, бижутерия">Коробка XS</option>
                        <option value="S" data-price="1500" data-desc="Обувь (1 пара), косметика, футболки">Коробка S</option>
                        <option value="M" data-price="2500" data-desc="Одежда (толстовки, джинсы), сумки">Коробка M</option>
                        <option value="L" data-price="3800" data-desc="Верхняя одежда, пуховики, техника">Коробка L</option>
                        <option value="XL" data-price="5000" data-desc="Крупные партии, объемные грузы">Коробка XL</option>
                        <option value="custom">Свой размер</option>
                    </select>
                </div>
                
                <!-- Dynamic Description -->
                <div id="boxDesc" class="mt-3 text-sm text-[var(--tg-theme-hint-color)] bg-white/50 p-2 rounded-lg">
                    Мелкие аксессуары, чехлы, бижутерия
                </div>
            </div>

            <!-- Custom Dimensions Input (Hidden by default) -->
            <div id="customDims" class="hidden animate-fade-in">
                <div class="card p-4">
                    <label class="block text-xs font-bold text-[var(--tg-theme-hint-color)] mb-2 uppercase tracking-wide">Габариты и Вес</label>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input type="number" id="dimL" placeholder="Длина (см)" class="text-center" oninput="updateCalc()">
                        <input type="number" id="dimW" placeholder="Ширина (см)" class="text-center" oninput="updateCalc()">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="dimH" placeholder="Высота (см)" class="text-center" oninput="updateCalc()">
                        <input type="number" id="weight" placeholder="Вес (кг)" class="text-center" oninput="updateCalc()">
                    </div>
                </div>
            </div>

            <!-- Total Price Display -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white text-center shadow-lg mt-4">
                <span class="text-blue-100 text-sm font-medium">Ориентировочная стоимость</span>
                <div class="text-4xl font-bold mt-2">
                    <span id="totalPrice">900</span> ₽
                </div>
            </div>
            
            <p class="text-[10px] text-center text-[var(--tg-theme-hint-color)] px-4 leading-relaxed">
                *Расчет является предварительным. Итоговая стоимость фиксируется после взвешивания на складе.
            </p>
        </div>
    </div>

    <!-- TAB 2: ORDER (BUYOUT) -->
    <div id="tab-order" class="tab-content">
        <h2 class="text-2xl font-bold mb-6 px-1">Выкуп</h2>
        
        <div id="orderItemsList" class="space-y-4">
            <!-- Items generated by JS -->
        </div>

        <!-- Add Button (In Flow) -->
        <button onclick="addOrderItem()" class="w-full mt-4 py-4 btn-secondary flex items-center justify-center gap-2">
            <i class="fas fa-plus"></i> Добавить товар
        </button>
    </div>

    <!-- TAB 3: SEARCH -->
    <div id="tab-search" class="tab-content">
        <h2 class="text-2xl font-bold mb-6 px-1">Поиск</h2>
        
        <div id="searchItemsList" class="space-y-4">
            <!-- Items generated by JS -->
        </div>

        <!-- Add Button (In Flow) -->
        <button onclick="addSearchItem()" class="w-full mt-4 py-4 btn-secondary flex items-center justify-center gap-2">
            <i class="fas fa-plus"></i> Добавить позицию
        </button>
    </div>


    <!-- FIXED ACTION BUTTONS -->
    <div class="action-bar">
        <!-- Button for Calculator -->
        <button id="btn-action-calc" onclick="sendCalc()" class="btn-main w-full py-4 text-lg shadow-xl">
            Рассчитать
        </button>
        
        <!-- Button for Order -->
        <button id="btn-action-order" onclick="sendOrder()" class="btn-main w-full py-4 text-lg shadow-xl hidden">
            Оформить заказ
        </button>

        <!-- Button for Search -->
        <button id="btn-action-search" onclick="sendSearch()" class="btn-main w-full py-4 text-lg shadow-xl hidden">
            Найти
        </button>
    </div>


    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('calc')">
            <i class="fas fa-calculator"></i>
            <span>Калькулятор</span>
        </div>
        <div class="nav-item" onclick="switchTab('order')">
            <i class="fas fa-shopping-bag"></i>
            <span>Выкуп</span>
        </div>
        <div class="nav-item" onclick="switchTab('search')">
            <i class="fas fa-search"></i>
            <span>Поиск</span>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        const IMGBB_API_KEY = '5f8914c62250150915f026194411130d'; 
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Курс юаня для примера
        const RATE = 13.5; 

        // State
        let currentTab = 'calc';
        let orderItems = [];
        let searchItems = [];

        // --- TABS LOGIC ---
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Reset nav styles
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Hide all action buttons
            document.getElementById('btn-action-calc').classList.add('hidden');
            document.getElementById('btn-action-order').classList.add('hidden');
            document.getElementById('btn-action-search').classList.add('hidden');

            // Activate current
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`btn-action-${tab}`).classList.remove('hidden');
            
            // Highlight nav
            const navIndex = ['calc', 'order', 'search'].indexOf(tab);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            
            currentTab = tab;
            
            // Re-render items if needed to fix layout glitches
            if(tab === 'order' && orderItems.length === 0) addOrderItem();
            if(tab === 'search' && searchItems.length === 0) addSearchItem();
        }

        // --- CALCULATOR LOGIC ---
        function updateCalc() {
            const select = document.getElementById('boxType');
            const customDiv = document.getElementById('customDims');
            const priceEl = document.getElementById('totalPrice');
            const descEl = document.getElementById('boxDesc');
            
            let price = 0;

            if (select.value === 'custom') {
                customDiv.classList.remove('hidden');
                descEl.innerText = "Расчет по объемному весу";
                
                const l = parseFloat(document.getElementById('dimL').value) || 0;
                const w = parseFloat(document.getElementById('dimW').value) || 0;
                const h = parseFloat(document.getElementById('dimH').value) || 0;
                const weight = parseFloat(document.getElementById('weight').value) || 0;
                
                // Простая логика: Объемный вес (L*W*H/5000) vs Реальный вес
                // Ставка например 450р за кг
                const volWeight = (l * w * h) / 5000;
                const finalWeight = Math.max(volWeight, weight);
                
                price = Math.ceil(Math.max(finalWeight * 450, 500)); 
            } else {
                customDiv.classList.add('hidden');
                const opt = select.options[select.selectedIndex];
                price = parseInt(opt.getAttribute('data-price'));
                descEl.innerText = opt.getAttribute('data-desc');
            }
            
            priceEl.innerText = price;
        }

        function sendCalc() {
            const select = document.getElementById('boxType');
            let data = { type: 'calc', packPrice: document.getElementById('totalPrice').innerText };
            
            if (select.value === 'custom') {
                data.boxName = 'Свой размер';
                data.l = document.getElementById('dimL').value;
                data.w = document.getElementById('dimW').value;
                data.h = document.getElementById('dimH').value;
                data.weight = document.getElementById('weight').value;
            } else {
                const opt = select.options[select.selectedIndex];
                data.boxName = opt.text; // Text from option
                // Assuming standard sizes for predefined boxes for the report
                const sizes = {
                    'XS': '20x20x20', 'S': '30x30x30', 'M': '40x40x40', 'L': '50x50x50', 'XL': '60x60x60'
                };
                const dims = sizes[select.value].split('x');
                data.l = dims[0]; data.w = dims[1]; data.h = dims[2];
            }

            tg.sendData(JSON.stringify(data));
        }

        // --- ORDER TAB LOGIC ---
        function addOrderItem() {
            const id = Date.now();
            const html = `
                <div id="order-item-${id}" class="card p-4 relative animate-fade-in">
                    <!-- Delete Button (Logic will hide it if only 1 item) -->
                    <button onclick="removeElement('order-item-${id}', 'order')" class="delete-btn absolute top-3 right-3 text-red-400 p-2">
                        <i class="fas fa-times"></i>
                    </button>

                    <h3 class="font-bold mb-3 text-sm text-[var(--tg-theme-text-color)]">Товар</h3>
                    
                    <input type="text" class="mb-3 bg-white" placeholder="Ссылка на товар" onchange="updateOrderItem(${id}, 'link', this.value)">
                    
                    <div class="flex gap-3 mb-3">
                        <input type="number" class="w-1/2 bg-white" placeholder="Цена (¥)" oninput="updateOrderItem(${id}, 'price', this.value)">
                        <div class="w-1/2 bg-gray-100 rounded-xl flex items-center justify-center text-sm font-bold text-[var(--tg-theme-hint-color)]">
                            <span id="res-rub-${id}">0 ₽</span>
                        </div>
                    </div>

                    <!-- Square Photo Button -->
                    <div class="flex flex-wrap gap-2" id="preview-area-${id}">
                        <label class="photo-btn text-[var(--tg-theme-hint-color)] hover:text-[var(--tg-theme-button-color)]">
                            <i class="fas fa-camera text-xl"></i>
                            <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this, ${id}, 'order')">
                        </label>
                    </div>
                </div>
            `;
            document.getElementById('orderItemsList').insertAdjacentHTML('beforeend', html);
            orderItems.push({ id, link: '', price: 0, resYuan: 0, imgUrls: [] });
            updateDeleteButtons('order');
        }

        function updateOrderItem(id, field, value) {
            const item = orderItems.find(i => i.id === id);
            if (!item) return;

            if (field === 'price') {
                const val = parseFloat(value) || 0;
                item.price = val;
                // Без комиссии, просто цена в рублях
                const rub = Math.ceil(val * RATE); 
                item.resYuan = val; // Store original yuan
                document.getElementById(`res-rub-${id}`).innerText = `${rub} ₽`;
            } else {
                item[field] = value;
            }
        }

        // --- SEARCH TAB LOGIC ---
        function addSearchItem() {
            const id = Date.now();
            const html = `
                <div id="search-item-${id}" class="card p-4 relative animate-fade-in">
                    <button onclick="removeElement('search-item-${id}', 'search')" class="delete-btn absolute top-3 right-3 text-red-400 p-2">
                        <i class="fas fa-times"></i>
                    </button>

                    <h3 class="font-bold mb-3 text-sm text-[var(--tg-theme-text-color)]">Позиция</h3>
                    
                    <textarea class="bg-white mb-3 h-24 resize-none" placeholder="Комментарий" onchange="updateSearchItem(${id}, 'comment', this.value)"></textarea>

                    <div class="flex flex-wrap gap-2" id="search-preview-area-${id}">
                        <label class="photo-btn text-[var(--tg-theme-hint-color)] hover:text-[var(--tg-theme-button-color)]">
                            <i class="fas fa-camera text-xl"></i>
                            <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this, ${id}, 'search')">
                        </label>
                    </div>
                </div>
            `;
            document.getElementById('searchItemsList').insertAdjacentHTML('beforeend', html);
            searchItems.push({ id, comment: '', imgUrls: [] });
            updateDeleteButtons('search');
        }

        function updateSearchItem(id, field, value) {
            const item = searchItems.find(i => i.id === id);
            if (item) item[field] = value;
        }

        // --- SHARED UTILS ---
        function removeElement(elementId, type) {
            const list = type === 'order' ? orderItems : searchItems;
            if (list.length <= 1) return; // Prevent deleting last item

            document.getElementById(elementId).remove();
            
            // Remove from array
            const id = parseInt(elementId.split('-').pop());
            if (type === 'order') {
                orderItems = orderItems.filter(i => i.id !== id);
            } else {
                searchItems = searchItems.filter(i => i.id !== id);
            }
            updateDeleteButtons(type);
        }

        function updateDeleteButtons(type) {
            const list = type === 'order' ? orderItems : searchItems;
            const containerId = type === 'order' ? 'orderItemsList' : 'searchItemsList';
            const buttons = document.querySelectorAll(`#${containerId} .delete-btn`);
            
            // Hide delete button if only 1 item exists
            buttons.forEach(btn => {
                btn.style.display = list.length > 1 ? 'block' : 'none';
            });
        }

        async function handleImageUpload(input, id, type) {
            const file = input.files[0];
            if (!file) return;

            // Find container for preview
            const previewArea = document.getElementById(type === 'order' ? `preview-area-${id}` : `search-preview-area-${id}`);
            
            // Create loading placeholder
            const loadId = `load-${Date.now()}`;
            const loadingHtml = `<div id="${loadId}" class="photo-btn animate-pulse"><i class="fas fa-spinner fa-spin"></i></div>`;
            // Insert before the Add button (label)
            input.parentElement.insertAdjacentHTML('beforebegin', loadingHtml);

            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                
                // Remove loader
                document.getElementById(loadId).remove();

                if (data.success) {
                    const imgUrl = data.data.url;
                    const thumbUrl = data.data.thumb.url;

                    // Update State
                    const list = type === 'order' ? orderItems : searchItems;
                    const item = list.find(i => i.id === id);
                    if (item) item.imgUrls.push(imgUrl);

                    // Show Preview (Square rounded)
                    const imgHtml = `<div class="w-[70px] h-[70px] rounded-2xl overflow-hidden border border-gray-200 relative">
                                        <img src="${thumbUrl}" class="w-full h-full object-cover">
                                     </div>`;
                    // Insert before the Add button
                    input.parentElement.insertAdjacentHTML('beforebegin', imgHtml);
                } else {
                    alert("Ошибка загрузки");
                }
            } catch (error) {
                document.getElementById(loadId).remove();
                alert("Ошибка сети");
            }
        }

        // --- SENDING ---
        function sendOrder() {
            if (orderItems.length === 0) return tg.showAlert("Пустой заказ!");
            tg.sendData(JSON.stringify({ type: 'order', items: orderItems }));
        }

        function sendSearch() {
            if (searchItems.length === 0) return tg.showAlert("Пустой поиск!");
            tg.sendData(JSON.stringify({ type: 'search', items: searchItems }));
        }

        // Init
        // Pre-fill tabs
        addOrderItem();
        addSearchItem();
        // Set styling
        document.body.style.backgroundColor = "var(--tg-theme-bg-color)";
    </script>
</body>
</html>
